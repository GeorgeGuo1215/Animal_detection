# ENMO虚高问题修复说明

## 🐛 问题描述

用户报告活动量(ENMO)值虚高：
- 5秒剧烈运动就能达到100的目标
- 静息状态正常（不增加）
- 其他活动状态增加过快

## 🔍 根本原因

**ENMO计算未归一化**：
- 原代码：`enmo = enmoSum`（50个样本的总和）
- 问题：ENMO值依赖于采样率，导致虚高

**测试数据验证**（50Hz采样率，1秒=50样本）：
| 活动类型 | 修复前ENMO/秒 | 修复后ENMO/秒 | 缩小倍数 |
|---------|--------------|--------------|---------|
| 静息 | 0 | 0 | - |
| 轻微晃动 | 0.06 | 0.001 | 60x |
| 慢走 | 3.33 | 0.067 | 50x |
| 快走/慢跑 | 6.78 | 0.136 | 50x |
| 剧烈运动 | 16.92 | 0.338 | 50x |

## ✅ 修复方案

### 1. ENMO计算归一化

**修改文件**: `web/activity-monitor.js` (第123-133行)

```javascript
// 修复前：
const enmo = enmoSum;  // 直接使用总和

// 修复后：
const enmo = enmoSum / this.fs;  // 除以采样率归一化
```

**效果**：ENMO值缩小50倍，变为合理范围

### 2. 调整默认目标值

**修改文件**:
- `web/activity-monitor.js` (第31行)
- `web/index.html` (第193行)
- `web/app.js` (第4322、4372行)

```javascript
// 修复前：
this.activityGoal = 100;  // 太高

// 修复后：
this.activityGoal = 2.0;  // 合理值：1-5
```

**HTML输入框**：
```html
<!-- 修复前 -->
<input type="number" id="activityENMOGoal" value="100" min="10" step="10">

<!-- 修复后 -->
<input type="number" id="activityENMOGoal" value="2.0" min="0.5" max="10" step="0.5">
```

## 🎯 修复后的预期值

### 每秒ENMO值（归一化后）

| 活动类型 | ENMO/秒 | 说明 |
|---------|---------|------|
| 静息 | 0 - 0.01 | 心跳呼吸引起的微小变化 |
| 轻微晃动 | 0.01 - 0.05 | 轻微移动 |
| 慢走 | 0.05 - 0.10 | 正常步行 |
| 快走 | 0.10 - 0.20 | 快速步行 |
| 慢跑 | 0.20 - 0.40 | 跑步 |
| 剧烈运动 | 0.40 - 1.00 | 跳跃、快速奔跑 |

### 达到目标所需时间

**目标值 = 2.0**

| 活动类型 | ENMO/秒 | 达到2.0所需时间 |
|---------|---------|----------------|
| 慢走 | 0.067 | 30秒 |
| 快走 | 0.136 | 15秒 |
| 慢跑 | 0.270 | 7秒 |
| 剧烈运动 | 0.338 | 6秒 |

**目标值建议**：
- **低活动量**: 0.5 - 1.0 (轻度活动10-30分钟)
- **中等活动量**: 1.0 - 3.0 (中度活动10-30分钟)
- **高活动量**: 3.0 - 5.0 (剧烈活动10-30分钟)

### 每日累积目标

假设宠物一天的活动模式：

| 活动类型 | 时长 | ENMO/秒 | 累积ENMO |
|---------|------|---------|---------|
| 睡觉/静息 | 18小时 | 0 | 0 |
| 轻度活动 | 4小时 | 0.05 | 720 |
| 中度活动 | 1小时 | 0.15 | 540 |
| 剧烈活动 | 1小时 | 0.30 | 1080 |
| **每日总计** | **24小时** | - | **2340** |

**推荐每日目标**：
- 低活动宠物: 500 - 1000
- 中等活动宠物: 1000 - 2000
- 高活动宠物: 2000 - 3000

## 🧪 测试步骤

### 1. 清除缓存并刷新
```
Cmd+Shift+R (Mac) 或 Ctrl+Shift+R (Windows)
```

### 2. 重新连接蓝牙
1. 打开 http://localhost:8000/index.html
2. 点击"连接蓝牙"
3. 点击"开始活动监测"

### 3. 验证静息状态
- **操作**: 将设备静置1分钟
- **预期**: ENMO保持在0或接近0（< 0.01）
- **实际**: _____

### 4. 验证慢走
- **操作**: 缓慢走路1分钟
- **预期**: ENMO增加 3-6 (0.05-0.10/秒 × 60秒)
- **实际**: _____

### 5. 验证快走
- **操作**: 快速走路1分钟
- **预期**: ENMO增加 8-12 (0.13-0.20/秒 × 60秒)
- **实际**: _____

### 6. 验证剧烈运动
- **操作**: 剧烈摇晃或跳跃10秒
- **预期**: ENMO增加 3-5 (0.30-0.50/秒 × 10秒)
- **实际**: _____

### 7. 验证目标达成时间
- **操作**: 设置目标为2.0，快速走路
- **预期**: 约15秒达到100%
- **实际**: _____

## 📊 控制台输出示例

**修复后的正常输出**：

```
📊 [5秒] ENMO=0.0678, MAD=0.0876, 强度=light, 新步数=0, 总步数=0
📊 [10秒] ENMO=0.1356, MAD=0.2489, 强度=moderate, 新步数=2, 总步数=2
📊 [15秒] ENMO=0.3384, MAD=0.4481, 强度=vigorous, 新步数=3, 总步数=5
📈 累加ENMO: +0.3384, 总计=0.54
```

**关键指标**：
- ENMO值在 0.01 - 0.50 范围内 ✓
- MAD值与活动强度匹配 ✓
- 步数合理增长 ✓

## ⚠️ 注意事项

1. **目标值不要设置太低**：建议最小0.5，否则几秒就能达到
2. **目标值不要设置太高**：建议最大10，否则需要长时间剧烈运动
3. **合理范围**：1.0 - 5.0 适合大多数场景

## 📝 技术细节

### ENMO定义

ENMO (Euclidean Norm Minus One) 是一种活动量化指标：

```
ENMO = max(0, SVM - 1.0)
其中 SVM = sqrt(ax² + ay² + az²)
```

### 归一化的必要性

**未归一化**：
- ENMO = Σ max(0, SVM - 1.0)  [对所有样本求和]
- 问题：值依赖于采样率和窗口大小

**归一化后**：
- ENMO = Σ max(0, SVM - 1.0) / N  [除以样本数]
- 优点：值独立于采样率，便于设置统一的目标

### 为什么除以采样率？

- 50Hz采样率：1秒有50个样本
- 如果每个样本ENMO=0.1，总和=5.0
- 归一化后：5.0 / 50 = 0.1（平均每样本的ENMO）
- 这样ENMO值反映的是**平均活动强度**，而不是**累积总量**

## ✅ 修复完成

- [x] ENMO计算归一化（除以采样率）
- [x] 调整默认目标值（100 → 2.0）
- [x] 更新HTML输入框范围（10-100 → 0.5-10）
- [x] 修改app.js解析为浮点数（parseInt → parseFloat）
- [x] 创建测试脚本验证修复效果

---

**版本**: 1.3.0
**更新时间**: 2026-01-27
**状态**: ENMO虚高问题已修复
