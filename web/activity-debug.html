<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ´»åŠ¨ç›‘æµ‹è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007AFF;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0051D5;
        }
        .output {
            background: #f0f0f0;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #34C759; }
        .error { color: #FF2D55; }
        .warning { color: #FF9500; }
    </style>
</head>
<body>
    <h1>ğŸ” æ´»åŠ¨ç›‘æµ‹æ¨¡å—è°ƒè¯•å·¥å…·</h1>

    <div class="debug-section">
        <h2>1. æ£€æŸ¥ä¾èµ–</h2>
        <button onclick="checkDependencies()">æ£€æŸ¥Chart.jså’ŒActivityMonitor</button>
        <div id="depOutput" class="output"></div>
    </div>

    <div class="debug-section">
        <h2>2. æ£€æŸ¥DOMå…ƒç´ </h2>
        <button onclick="checkDOMElements()">æ£€æŸ¥Canvaså…ƒç´ </button>
        <div id="domOutput" class="output"></div>
    </div>

    <div class="debug-section">
        <h2>3. æ£€æŸ¥ActivityMonitorçŠ¶æ€</h2>
        <button onclick="checkMonitorStatus()">æ£€æŸ¥ç›‘æµ‹å™¨çŠ¶æ€</button>
        <div id="statusOutput" class="output"></div>
    </div>

    <div class="debug-section">
        <h2>4. æ‰‹åŠ¨è§¦å‘æ“ä½œ</h2>
        <button onclick="manualInitCharts()">æ‰‹åŠ¨åˆå§‹åŒ–å›¾è¡¨</button>
        <button onclick="manualUpdateCharts()">æ‰‹åŠ¨æ›´æ–°å›¾è¡¨</button>
        <button onclick="addTestData()">æ·»åŠ æµ‹è¯•æ•°æ®</button>
        <div id="manualOutput" class="output"></div>
    </div>

    <div class="debug-section">
        <h2>5. æŸ¥çœ‹æ•°æ®</h2>
        <button onclick="viewData()">æŸ¥çœ‹å½“å‰æ•°æ®</button>
        <div id="dataOutput" class="output"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            output.innerHTML += `<div class="${className}">${message}</div>`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function checkDependencies() {
            clearLog('depOutput');

            // æ£€æŸ¥Chart.js
            if (typeof Chart !== 'undefined') {
                log('depOutput', 'âœ… Chart.jså·²åŠ è½½: ' + Chart.version, 'success');
            } else {
                log('depOutput', 'âŒ Chart.jsæœªåŠ è½½', 'error');
            }

            // æ£€æŸ¥ActivityMonitor
            if (typeof ActivityMonitor !== 'undefined') {
                log('depOutput', 'âœ… ActivityMonitorç±»å·²å®šä¹‰', 'success');
            } else {
                log('depOutput', 'âŒ ActivityMonitorç±»æœªå®šä¹‰', 'error');
            }

            // æ£€æŸ¥appå¯¹è±¡
            if (typeof window.app !== 'undefined') {
                log('depOutput', 'âœ… window.appå¯¹è±¡å­˜åœ¨', 'success');

                if (window.app.activityMonitor) {
                    log('depOutput', 'âœ… activityMonitorå®ä¾‹å·²åˆ›å»º', 'success');
                    log('depOutput', `   - å›¾è¡¨æ•°é‡: ${Object.keys(window.app.activityMonitor.charts).length}`, 'info');
                    log('depOutput', `   - ç›‘æµ‹å¯ç”¨: ${window.app.activityMonitorEnabled}`, 'info');
                } else {
                    log('depOutput', 'âš ï¸ activityMonitorå®ä¾‹æœªåˆ›å»º', 'warning');
                }
            } else {
                log('depOutput', 'âŒ window.appå¯¹è±¡ä¸å­˜åœ¨', 'error');
            }
        }

        function checkDOMElements() {
            clearLog('domOutput');

            const elements = [
                'activityStepsRingChart',
                'activityENMORingChart',
                'activityHourlyStepsChart',
                'activityHourlyENMOChart',
                'activityIntensityTrendChart'
            ];

            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const visible = el.offsetParent !== null;
                    log('domOutput', `âœ… ${id}: å­˜åœ¨ (å¯è§: ${visible})`, 'success');
                } else {
                    log('domOutput', `âŒ ${id}: ä¸å­˜åœ¨`, 'error');
                }
            });

            // æ£€æŸ¥ä»ªè¡¨æ¿
            const dashboard = document.getElementById('activityDashboard');
            if (dashboard) {
                const visible = dashboard.style.display !== 'none';
                log('domOutput', `ğŸ“Š activityDashboard: ${visible ? 'å¯è§' : 'éšè—'}`, visible ? 'success' : 'warning');
            }
        }

        function checkMonitorStatus() {
            clearLog('statusOutput');

            if (!window.app || !window.app.activityMonitor) {
                log('statusOutput', 'âŒ ActivityMonitoræœªåˆå§‹åŒ–', 'error');
                return;
            }

            const monitor = window.app.activityMonitor;
            log('statusOutput', 'ğŸ“Š ActivityMonitorçŠ¶æ€:', 'info');
            log('statusOutput', `   - æ€»æ­¥æ•°: ${monitor.totalSteps}`, 'info');
            log('statusOutput', `   - æ€»æ´»åŠ¨é‡: ${monitor.totalENMO.toFixed(2)}`, 'info');
            log('statusOutput', `   - å½“å‰å¼ºåº¦: ${monitor.currentIntensity}`, 'info');
            log('statusOutput', `   - å†å²è®°å½•: ${monitor.activityHistory.length}æ¡`, 'info');
            log('statusOutput', `   - æ­¥æ•°å†å²: ${monitor.stepHistory.length}æ¡`, 'info');
            log('statusOutput', `   - åŠ é€Ÿåº¦ç¼“å­˜: ${monitor.accBufferX.length}ä¸ªæ ·æœ¬`, 'info');
            log('statusOutput', `   - å·²å¤„ç†ç´¢å¼•: ${monitor.lastProcessedIndex}`, 'info');
            log('statusOutput', `   - å›¾è¡¨å¯¹è±¡: ${Object.keys(monitor.charts).length}ä¸ª`, 'info');

            Object.keys(monitor.charts).forEach(key => {
                log('statusOutput', `     â€¢ ${key}: ${monitor.charts[key] ? 'å·²åˆ›å»º' : 'æœªåˆ›å»º'}`,
                    monitor.charts[key] ? 'success' : 'error');
            });
        }

        function manualInitCharts() {
            clearLog('manualOutput');

            if (!window.app || !window.app.activityMonitor) {
                log('manualOutput', 'âŒ ActivityMonitoræœªåˆå§‹åŒ–', 'error');
                return;
            }

            try {
                log('manualOutput', 'ğŸ¨ å¼€å§‹åˆå§‹åŒ–å›¾è¡¨...', 'info');
                window.app.activityMonitor.initializeCharts();
                log('manualOutput', 'âœ… å›¾è¡¨åˆå§‹åŒ–å®Œæˆ', 'success');
                log('manualOutput', `   åˆ›å»ºäº† ${Object.keys(window.app.activityMonitor.charts).length} ä¸ªå›¾è¡¨`, 'info');
            } catch (e) {
                log('manualOutput', `âŒ åˆå§‹åŒ–å¤±è´¥: ${e.message}`, 'error');
            }
        }

        function manualUpdateCharts() {
            clearLog('manualOutput');

            if (!window.app || !window.app.activityMonitor) {
                log('manualOutput', 'âŒ ActivityMonitoræœªåˆå§‹åŒ–', 'error');
                return;
            }

            try {
                log('manualOutput', 'ğŸ“Š å¼€å§‹æ›´æ–°å›¾è¡¨...', 'info');
                window.app.activityMonitor.updateCharts();
                log('manualOutput', 'âœ… å›¾è¡¨æ›´æ–°å®Œæˆ', 'success');
            } catch (e) {
                log('manualOutput', `âŒ æ›´æ–°å¤±è´¥: ${e.message}`, 'error');
            }
        }

        function addTestData() {
            clearLog('manualOutput');

            if (!window.app || !window.app.activityMonitor) {
                log('manualOutput', 'âŒ ActivityMonitoræœªåˆå§‹åŒ–', 'error');
                return;
            }

            const monitor = window.app.activityMonitor;

            // æ·»åŠ æ¨¡æ‹Ÿçš„èµ°è·¯æ•°æ®
            log('manualOutput', 'ğŸš¶ æ·»åŠ æ¨¡æ‹Ÿèµ°è·¯æ•°æ®...', 'info');
            for (let i = 0; i < 100; i++) {
                const t = i / 50; // 2ç§’çš„æ•°æ®
                // æ¨¡æ‹Ÿèµ°è·¯çš„åŠ é€Ÿåº¦æ¨¡å¼ (1.5Hzæ­¥é¢‘)
                const ax = 0.1 * Math.sin(2 * Math.PI * 1.5 * t);
                const ay = 0.1 * Math.cos(2 * Math.PI * 1.5 * t);
                const az = 1.0 + 0.2 * Math.sin(2 * Math.PI * 1.5 * t);

                monitor.addAccelerometerData(ax, ay, az, Date.now() + i * 20);
            }

            log('manualOutput', 'âœ… å·²æ·»åŠ 100ä¸ªæµ‹è¯•æ•°æ®ç‚¹', 'success');
            log('manualOutput', `   å½“å‰æ­¥æ•°: ${monitor.totalSteps}`, 'info');
            log('manualOutput', `   å½“å‰æ´»åŠ¨é‡: ${monitor.totalENMO.toFixed(2)}`, 'info');
        }

        function viewData() {
            clearLog('dataOutput');

            if (!window.app || !window.app.activityMonitor) {
                log('dataOutput', 'âŒ ActivityMonitoræœªåˆå§‹åŒ–', 'error');
                return;
            }

            const monitor = window.app.activityMonitor;
            const summary = monitor.getSummary();

            log('dataOutput', 'ğŸ“Š å½“å‰æ•°æ®æ‘˜è¦:', 'info');
            log('dataOutput', JSON.stringify(summary, null, 2), 'info');

            log('dataOutput', '\nğŸ“ˆ æ¯å°æ—¶æ•°æ®:', 'info');
            monitor.hourlyData.forEach((h, i) => {
                if (h.steps > 0 || h.activity > 0) {
                    log('dataOutput', `   ${i}:00 - æ­¥æ•°:${h.steps}, æ´»åŠ¨é‡:${h.activity.toFixed(2)}, å¼ºåº¦:${h.intensity}`, 'info');
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkDependencies();
                checkDOMElements();
            }, 500);
        });
    </script>
</body>
</html>
