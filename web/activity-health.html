<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨é‡ä¸æ­¥æ•°ç›‘æµ‹ - ç±»Apple Health</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="bluetooth.js"></script>
    <script src="activity-monitor.js"></script>
    <style>
        /* Apple Health é£æ ¼æ ·å¼ */
        .activity-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .activity-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .activity-header h1 {
            font-size: 32px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 10px;
        }

        .activity-header p {
            font-size: 16px;
            color: #86868b;
        }

        /* æ´»åŠ¨ç¯åŒºåŸŸ */
        .activity-rings-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .activity-ring-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .ring-chart-container {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto 16px;
        }

        .ring-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: 700;
            color: #1d1d1f;
        }

        .ring-label {
            font-size: 14px;
            color: #86868b;
            margin-bottom: 8px;
        }

        .ring-value {
            font-size: 24px;
            font-weight: 600;
            color: #1d1d1f;
        }

        .ring-goal {
            font-size: 14px;
            color: #86868b;
            margin-top: 4px;
        }

        /* å›¾è¡¨åŒºåŸŸ */
        .activity-charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .activity-chart-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 16px;
        }

        .chart-container {
            height: 300px;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .activity-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 14px;
            color: #86868b;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1d1d1f;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .activity-controls {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover {
            background: #0051D5;
        }

        .btn-secondary {
            background: #8E8E93;
            color: white;
        }

        .btn-secondary:hover {
            background: #636366;
        }

        .btn-success {
            background: #34C759;
            color: white;
        }

        .btn-success:hover {
            background: #248A3D;
        }

        .goal-input {
            padding: 8px 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 14px;
            margin-right: 10px;
            width: 120px;
        }
    </style>
</head>
<body>
    <div class="activity-container">
        <header class="activity-header">
            <h1>ğŸƒ æ´»åŠ¨é‡ä¸æ­¥æ•°ç›‘æµ‹</h1>
            <p>åŸºäºIMUåŠ é€Ÿåº¦è®¡çš„å®æ—¶æ´»åŠ¨åˆ†æ - Apple Healthé£æ ¼</p>
        </header>

        <!-- æ§åˆ¶é¢æ¿ -->
        <section class="activity-controls">
            <h3>è“ç‰™è¿æ¥ä¸æ§åˆ¶</h3>
            <button class="btn btn-primary" id="activityBleConnect" onclick="connectBluetooth()">è¿æ¥è“ç‰™è®¾å¤‡</button>
            <button class="btn btn-secondary" id="activityBleDisconnect" onclick="disconnectBluetooth()" style="display:none;">æ–­å¼€è¿æ¥</button>
            <button class="btn btn-success" id="activityResetDaily" onclick="resetDailyData()">é‡ç½®ä»Šæ—¥æ•°æ®</button>

            <div style="margin-top: 16px;">
                <label>æ¯æ—¥æ­¥æ•°ç›®æ ‡: </label>
                <input type="number" id="dailyStepsGoal" class="goal-input" value="1000" min="100" step="100">
                <label>æ¯æ—¥æ´»åŠ¨é‡ç›®æ ‡: </label>
                <input type="number" id="dailyActivityGoal" class="goal-input" value="100" min="10" step="10">
                <button class="btn btn-primary" onclick="updateGoals()">æ›´æ–°ç›®æ ‡</button>
            </div>
        </section>

        <!-- æ´»åŠ¨ç¯ (ç±»ä¼¼Apple Health) -->
        <section class="activity-rings-section">
            <div class="activity-ring-card">
                <div class="ring-label">æ­¥æ•°</div>
                <div class="ring-chart-container">
                    <canvas id="activityStepsRingChart"></canvas>
                    <div class="ring-center-text" id="activityStepsGoal">0%</div>
                </div>
                <div class="ring-value" id="activityTotalSteps">0</div>
                <div class="ring-goal">ç›®æ ‡: <span id="displayStepsGoal">1000</span> æ­¥</div>
            </div>

            <div class="activity-ring-card">
                <div class="ring-label">æ´»åŠ¨é‡ (ENMO)</div>
                <div class="ring-chart-container">
                    <canvas id="activityENMORingChart"></canvas>
                    <div class="ring-center-text" id="activityENMOGoal">0%</div>
                </div>
                <div class="ring-value" id="activityTotalENMO">0.00</div>
                <div class="ring-goal">ç›®æ ‡: <span id="displayActivityGoal">100</span></div>
            </div>
        </section>

        <!-- å®æ—¶ç»Ÿè®¡ -->
        <section class="activity-stats">
            <div class="stat-card">
                <div class="stat-label">å½“å‰æ´»åŠ¨å¼ºåº¦</div>
                <div class="stat-value" id="activityCurrentIntensity">é™æ¯</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€åæ›´æ–°æ—¶é—´</div>
                <div class="stat-value" id="activityLastUpdate" style="font-size: 20px;">--:--:--</div>
            </div>
        </section>

        <!-- æ¯å°æ—¶å›¾è¡¨ -->
        <section class="activity-charts-section">
            <div class="activity-chart-card">
                <h3 class="chart-title">ğŸ“Š æ¯å°æ—¶æ­¥æ•°åˆ†å¸ƒ</h3>
                <div class="chart-container">
                    <canvas id="activityHourlyStepsChart"></canvas>
                </div>
            </div>

            <div class="activity-chart-card">
                <h3 class="chart-title">ğŸ“ˆ æ¯å°æ—¶æ´»åŠ¨é‡åˆ†å¸ƒ</h3>
                <div class="chart-container">
                    <canvas id="activityHourlyENMOChart"></canvas>
                </div>
            </div>
        </section>

        <!-- å®æ—¶è¶‹åŠ¿å›¾ -->
        <section class="activity-charts-section">
            <div class="activity-chart-card" style="grid-column: 1 / -1;">
                <h3 class="chart-title">ğŸ“‰ å®æ—¶æ´»åŠ¨å¼ºåº¦è¶‹åŠ¿ (æœ€è¿‘10åˆ†é’Ÿ)</h3>
                <div class="chart-container">
                    <canvas id="activityIntensityTrendChart"></canvas>
                </div>
            </div>
        </section>

        <!-- çŠ¶æ€æ—¥å¿— -->
        <section class="activity-controls">
            <h3>ç³»ç»Ÿæ—¥å¿—</h3>
            <div id="activityLog" style="background: #f5f5f7; padding: 16px; border-radius: 8px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                ç­‰å¾…è¿æ¥è“ç‰™è®¾å¤‡...
            </div>
        </section>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let activityMonitor = null;
        let bleDevice = null;
        let bleCharacteristic = null;

        // åˆå§‹åŒ–æ´»åŠ¨ç›‘æµ‹å™¨
        function initActivityMonitor() {
            const samplingRate = 50; // 50Hzé‡‡æ ·ç‡
            activityMonitor = new ActivityMonitor(samplingRate);
            activityMonitor.initializeCharts();

            // ä»è¾“å…¥æ¡†è¯»å–ç›®æ ‡å€¼
            const stepsGoal = parseInt(document.getElementById('dailyStepsGoal').value) || 1000;
            const activityGoal = parseInt(document.getElementById('dailyActivityGoal').value) || 100;
            activityMonitor.dailyGoal = stepsGoal;
            activityMonitor.activityGoal = activityGoal;

            updateGoalDisplay();
            logMessage('æ´»åŠ¨ç›‘æµ‹å™¨åˆå§‹åŒ–å®Œæˆ');
        }

        // è¿æ¥è“ç‰™è®¾å¤‡
        async function connectBluetooth() {
            try {
                logMessage('æ­£åœ¨æœç´¢è“ç‰™è®¾å¤‡...');

                // è¯·æ±‚è“ç‰™è®¾å¤‡
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e'] }]
                });

                logMessage(`å·²é€‰æ‹©è®¾å¤‡: ${bleDevice.name}`);

                // è¿æ¥åˆ°GATTæœåŠ¡å™¨
                const server = await bleDevice.gatt.connect();
                logMessage('å·²è¿æ¥åˆ°GATTæœåŠ¡å™¨');

                // è·å–æœåŠ¡å’Œç‰¹å¾
                const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
                bleCharacteristic = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');

                // å¼€å§‹æ¥æ”¶é€šçŸ¥
                await bleCharacteristic.startNotifications();
                bleCharacteristic.addEventListener('characteristicvaluechanged', handleBleData);

                logMessage('âœ… è“ç‰™è¿æ¥æˆåŠŸï¼Œå¼€å§‹æ¥æ”¶æ•°æ®');

                // æ›´æ–°UI
                document.getElementById('activityBleConnect').style.display = 'none';
                document.getElementById('activityBleDisconnect').style.display = 'inline-block';

            } catch (error) {
                logMessage(`âŒ è“ç‰™è¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        // æ–­å¼€è“ç‰™è¿æ¥
        function disconnectBluetooth() {
            if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
                logMessage('è“ç‰™å·²æ–­å¼€');
            }

            document.getElementById('activityBleConnect').style.display = 'inline-block';
            document.getElementById('activityBleDisconnect').style.display = 'none';
        }

        // å¤„ç†è“ç‰™æ•°æ®
        function handleBleData(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const text = decoder.decode(value);

            // è§£ææ•°æ®æ ¼å¼: ADC:val1 val2|Acc:x y z|Gyr:x y z|T:temp
            const accMatch = text.match(/Acc:([-\d.]+)\s+([-\d.]+)\s+([-\d.]+)/);

            if (accMatch && activityMonitor) {
                const ax = parseFloat(accMatch[1]);
                const ay = parseFloat(accMatch[2]);
                const az = parseFloat(accMatch[3]);
                const timestamp = Date.now();

                // æ·»åŠ åŠ é€Ÿåº¦æ•°æ®åˆ°ç›‘æµ‹å™¨
                activityMonitor.addAccelerometerData(ax, ay, az, timestamp);
            }
        }

        // æ›´æ–°ç›®æ ‡å€¼
        function updateGoals() {
            const stepsGoal = parseInt(document.getElementById('dailyStepsGoal').value) || 1000;
            const activityGoal = parseInt(document.getElementById('dailyActivityGoal').value) || 100;

            if (activityMonitor) {
                activityMonitor.dailyGoal = stepsGoal;
                activityMonitor.activityGoal = activityGoal;
                activityMonitor.updateCharts();
            }

            updateGoalDisplay();
            logMessage(`ç›®æ ‡å·²æ›´æ–°: æ­¥æ•°=${stepsGoal}, æ´»åŠ¨é‡=${activityGoal}`);
        }

        // æ›´æ–°ç›®æ ‡æ˜¾ç¤º
        function updateGoalDisplay() {
            document.getElementById('displayStepsGoal').textContent =
                document.getElementById('dailyStepsGoal').value;
            document.getElementById('displayActivityGoal').textContent =
                document.getElementById('dailyActivityGoal').value;
        }

        // é‡ç½®æ¯æ—¥æ•°æ®
        function resetDailyData() {
            if (activityMonitor) {
                activityMonitor.resetDailyData();
                logMessage('æ¯æ—¥æ•°æ®å·²é‡ç½®');
            }
        }

        // æ—¥å¿—è¾“å‡º
        function logMessage(message) {
            const logDiv = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            initActivityMonitor();
            logMessage('é¡µé¢åŠ è½½å®Œæˆ');
        });
    </script>
</body>
</html>
