<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 防止浏览器缓存旧版 index.html（否则会出现“明明改了代码但页面仍显示旧版/缺少IMU单元”的情况） -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>毫米波雷达数据处理系统 - Web版</title>
    <link rel="stylesheet" href="style.css?v=20260129-1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="fft.js?v=20260113-4"></script>
    <script src="bluetooth.js?v=20260113-4"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>🎯 毫米波雷达数据处理系统</h1>
            <p class="subtitle">基于Web的生理信号分析工具</p>
        </header>

        <div class="main-content">
            <!-- 蓝牙实时数据区域 -->
            <section class="upload-section">
                <h2>📶 蓝牙实时数据接口</h2>
                <div class="file-actions">
                    <button class="btn btn-primary" id="bleConnectBtn" onclick="bleConnect()">连接蓝牙</button>
                    <button class="btn btn-secondary" id="bleDisconnectBtn" onclick="bleDisconnect()" style="display:none;">断开</button>
                    <button class="btn btn-success" id="bleStartRecordBtn" onclick="bleStartRecording()" style="display:none;">开始记录</button>
                    <button class="btn btn-danger" id="bleStopRecordBtn" onclick="bleStopRecording()" style="display:none;">结束记录</button>
                    <button class="btn btn-info" id="bleShowChartsBtn" onclick="showBluetoothCharts()" style="display:none;">显示蓝牙图表</button>
                    <button class="btn btn-secondary" id="bleDiagBtn" onclick="bleQuickDiagnose()" style="display:none;">连接诊断(复制)</button>
                    <button class="btn btn-primary" id="bleAzureBtn" onclick="bleAzureDiagnose()" style="display:none; margin-left:10px;">AI诊断(本次录制)</button>
                    <button class="btn btn-warning" onclick="startSimulationTest()" style="margin-left:10px;">模拟测试</button>
                </div>

                <div class="ble-upload-config">
                    <label for="bleUploadUrl">上报接口:</label>
                    <input id="bleUploadUrl" type="text" placeholder="http://127.0.0.1:9001/ingest" class="input-url">
                    <label for="bleAnimalId">animal_id:</label>
                    <input id="bleAnimalId" type="text" placeholder="dog_001" class="input-sm">
                    <label for="bleDeviceId">device_id:</label>
                    <input id="bleDeviceId" type="text" placeholder="ble_device_01" class="input-md">
                    <label for="bleUploadInterval">间隔(s):</label>
                    <input id="bleUploadInterval" type="number" min="5" value="10" class="input-xs">
                    <button class="btn btn-success" id="bleStartUploadBtn" onclick="bleStartUpload()" style="display:none;">开始上传</button>
                    <button class="btn btn-danger" id="bleStopUploadBtn" onclick="bleStopUpload()" style="display:none;">停止上传</button>
                    <span id="bleUploadStatus">未上传</span>
                </div>
                
                <!-- 连接状态和实时数据显示 -->
                <div class="ble-status">
                    <div class="status-log" id="bleLog"></div>
                    
                    <!-- 实时数据监控 -->
                    <div id="bleRealTimeData" style="display:none;">
                        <h4>📡 实时数据流:</h4>
                        <div class="realtime-stats">
                            <div class="stat-item">
                                <span class="stat-label">接收数据点:</span>
                                <span class="stat-value" id="bleDataCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">实际接收频率:</span>
                                <span class="stat-value" id="bleActualFs">-- Hz</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">丢包率(估算):</span>
                                <span class="stat-value" id="blePacketLoss">-- %</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">间隔抖动:</span>
                                <span class="stat-value" id="bleJitter">-- ms</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">当前心率:</span>
                                <span class="stat-value" id="bleCurrentHR">-- bpm</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">当前呼吸:</span>
                                <span class="stat-value" id="bleCurrentResp">-- bpm</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">I/Q 调试:</span>
                                <span class="stat-value" id="bleCurrentIQ">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">当前温度:</span>
                                <span class="stat-value" id="bleCurrentTemp">-- °C</span>
                            </div>
                        </div>
                        <div class="raw-data-log" id="bleRawDataLog">
                            <strong>原始数据:</strong><br/>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 静息心率监测模块（独立模块） -->
            <section class="upload-section resting-section">
                <h2>🛌 静息心率呼吸率长期监测</h2>
                <p class="section-desc">
                    系统将通过活动监测模块自动判断宠物是否处于静息状态，只在静息时记录心率和呼吸率
                </p>
                
                <!-- 控制按钮 -->
                <div class="file-actions">
                    <button class="btn btn-success" id="restingStartBtn" onclick="startRestingMonitor()" style="display:none;">
                        🎯 开始静息监测
                    </button>
                    <button class="btn btn-danger" id="restingStopBtn" onclick="stopRestingMonitor()" style="display:none;">
                        ⏹️ 停止监测
                    </button>
                    <button class="btn btn-primary" id="restingSaveBtn" onclick="saveRestingData()" style="display:none;">
                        💾 保存数据
                    </button>
                    <button class="btn btn-info" id="restingConfigBtn" onclick="configRestingMonitor()" style="display:none;">
                        ⚙️ 配置参数
                    </button>
                    <button class="btn btn-secondary" id="restingClearBtn" onclick="clearRestingData()" style="display:none;">
                        🗑️ 清空数据
                    </button>
                </div>
                
                <!-- 状态面板 -->
                <div id="restingStatusPanel" class="resting-status-panel" style="display:none;">
                    <h4 class="panel-title">📊 监测状态</h4>
                    
                    <div class="resting-stats-grid">
                        <div class="resting-stat-card">
                            <div class="resting-stat-label">当前状态</div>
                            <div class="resting-stat-value" id="restingStateText">🚶 活动中</div>
                        </div>
                        <div class="resting-stat-card">
                            <div class="resting-stat-label">本次静息持续</div>
                            <div class="resting-stat-value" id="restingCurrentDuration">-- 秒</div>
                        </div>
                        <div class="resting-stat-card">
                            <div class="resting-stat-label">已记录数据</div>
                            <div class="resting-stat-value" id="restingTotalRecords">0 条</div>
                        </div>
                        <div class="resting-stat-card">
                            <div class="resting-stat-label">平均静息心率</div>
                            <div class="resting-stat-value" id="restingAvgHR" style="color:#dc3545;">-- bpm</div>
                        </div>
                        <div class="resting-stat-card">
                            <div class="resting-stat-label">平均静息呼吸</div>
                            <div class="resting-stat-value" id="restingAvgRR" style="color:#28a745;">-- bpm</div>
                        </div>
                    </div>

                    <!-- 实时静息数据 -->
                    <div class="resting-info-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-top: 20px;">
                        <strong>💓 实时静息数据</strong>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9;">当前心率</div>
                                <div id="restingCurrentHR" style="font-size: 24px; font-weight: bold; margin: 5px 0;">-- bpm</div>
                                <div style="font-size: 11px; opacity: 0.8;">静息状态</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9;">当前呼吸</div>
                                <div id="restingCurrentRR" style="font-size: 24px; font-weight: bold; margin: 5px 0;">-- bpm</div>
                                <div style="font-size: 11px; opacity: 0.8;">静息状态</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9;">最后更新</div>
                                <div id="restingLastUpdate" style="font-size: 24px; font-weight: bold; margin: 5px 0;">--:--:--</div>
                                <div style="font-size: 11px; opacity: 0.8;">时间</div>
                            </div>
                        </div>
                    </div>

                    <!-- 实时静息心率图 -->
                    <div class="resting-stat-card" style="grid-column: span 2; margin-top: 20px;">
                        <h4>📈 实时静息心率</h4>
                        <canvas id="restingRealtimeHRChart" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- 每分钟静息心率图 -->
                    <div class="resting-stat-card" style="grid-column: span 2;">
                        <h4>⏱️ 每分钟静息心率</h4>
                        <canvas id="restingMinuteHRChart" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- 每小时静息心率图 -->
                    <div class="resting-stat-card" style="grid-column: span 2;">
                        <h4>🕐 每小时静息心率</h4>
                        <canvas id="restingHourlyHRChart" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- 参数说明 -->
                    <div class="resting-info-box">
                        <p>
                            <strong>💡 当前参数：</strong>
                            <br/>• IMU 稳定阈值: <strong id="restingThresholdDisplay">2.0</strong>
                            <br/>• 判定静息时长: <strong id="restingStableDurDisplay">5</strong> 秒
                            <br/>• 最小记录时长: <strong id="restingMinDurDisplay">10</strong> 秒
                            <br/><span class="text-muted">点击"配置参数"可调整</span>
                        </p>
                    </div>
                    
                    <!-- 日志区域 -->
                    <div class="resting-log-container">
                        <div id="restingLog"></div>
                    </div>
                </div>
            </section>

            <!-- 活动量与步数监测模块 -->
            <section class="upload-section activity-section">
                <h2>🏃 活动量与步数监测</h2>
                <p class="section-desc">
                    基于IMU加速度计数据，实时计算活动量(ENMO)、步数和卡路里消耗，提供可视化展示
                </p>

                <!-- 控制按钮 -->
                <div class="file-actions">
                    <button class="btn btn-success" id="activityStartBtn" onclick="startActivityMonitor()" style="display:none;">
                        🎯 开始活动监测
                    </button>
                    <button class="btn btn-danger" id="activityStopBtn" onclick="stopActivityMonitor()" style="display:none;">
                        ⏹️ 停止监测
                    </button>
                    <button class="btn btn-warning" id="activityResetBtn" onclick="resetActivityData()" style="display:none;">
                        🔄 重置今日数据
                    </button>
                    <div style="display:inline-block; margin-left: 20px;">
                        <label>宠物体重(kg):</label>
                        <input type="number" id="petWeight" value="10.0" min="1" max="100" step="0.5" style="width:80px; padding:5px;">
                        <label style="margin-left:10px;">步数目标:</label>
                        <input type="number" id="activityStepsGoal" value="1000" min="100" step="100" style="width:100px; padding:5px;">
                        <label style="margin-left:10px;">活动量目标:</label>
                        <input type="number" id="activityENMOGoal" value="2.0" min="0.5" max="10" step="0.5" style="width:100px; padding:5px;">
                        <label style="margin-left:10px;">卡路里目标(kcal):</label>
                        <input type="number" id="activityCalorieGoal" value="100" min="10" max="500" step="10" style="width:100px; padding:5px;">
                        <button class="btn btn-primary" onclick="updateActivityGoals()" style="margin-left:10px;">更新目标</button>
                    </div>
                </div>

                <!-- 活动环和统计 -->
                <div id="activityDashboard" style="display:none;">
                    <!-- 活动环区域 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div class="resting-stat-card" style="text-align: center; padding: 24px;">
                            <div style="font-size: 14px; color: #86868b; margin-bottom: 16px;">步数</div>
                            <div style="position: relative; width: 180px; height: 180px; margin: 0 auto;">
                                <canvas id="activityStepsRingChart"></canvas>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; font-weight: 700;" id="activityStepsPercent">0%</div>
                            </div>
                            <div style="font-size: 32px; font-weight: 700; margin-top: 16px;" id="activityTotalSteps">0</div>
                            <div style="font-size: 14px; color: #86868b;">目标: <span id="displayStepsGoal">1000</span> 步</div>
                        </div>

                        <div class="resting-stat-card" style="text-align: center; padding: 24px;">
                            <div style="font-size: 14px; color: #86868b; margin-bottom: 16px;">活动量 (ENMO)</div>
                            <div style="position: relative; width: 180px; height: 180px; margin: 0 auto;">
                                <canvas id="activityENMORingChart"></canvas>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; font-weight: 700;" id="activityENMOPercent">0%</div>
                            </div>
                            <div style="font-size: 32px; font-weight: 700; margin-top: 16px;" id="activityTotalENMO">0.00</div>
                            <div style="font-size: 14px; color: #86868b;">目标: <span id="displayActivityGoal">2.0</span></div>
                        </div>

                        <div class="resting-stat-card" style="text-align: center; padding: 24px;">
                            <div style="font-size: 14px; color: #86868b; margin-bottom: 16px;">卡路里消耗</div>
                            <div style="position: relative; width: 180px; height: 180px; margin: 0 auto;">
                                <canvas id="activityCalorieRingChart"></canvas>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 28px; font-weight: 700;" id="activityCaloriePercent">0%</div>
                            </div>
                            <div style="font-size: 32px; font-weight: 700; margin-top: 16px;" id="activityTotalCalories">0.00</div>
                            <div style="font-size: 14px; color: #86868b;">目标: <span id="displayCalorieGoal">100</span> kcal</div>
                            <div style="font-size: 12px; color: #86868b; margin-top: 8px;">METs: <span id="activityCurrentMETs">1.0</span></div>
                        </div>

                        <div class="resting-stat-card" style="padding: 24px;">
                            <div style="font-size: 14px; color: #86868b; margin-bottom: 8px;">当前活动强度</div>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 16px;" id="activityCurrentIntensity">静息</div>
                            <div style="font-size: 14px; color: #86868b; margin-bottom: 4px;">宠物体重</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;" id="activityPetWeight">10.0 kg</div>
                            <div style="font-size: 14px; color: #86868b; margin-bottom: 4px;">基础代谢(RER)</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 12px;" id="activityRER">0 kcal/day</div>
                            <div style="font-size: 14px; color: #86868b; margin-bottom: 4px;">最后更新</div>
                            <div style="font-size: 18px; font-weight: 600;" id="activityLastUpdate">--:--:--</div>
                        </div>
                    </div>

                    <!-- 图表区域 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div class="resting-stat-card" style="padding: 24px;">
                            <h4 style="margin-bottom: 16px;">📊 每小时步数分布</h4>
                            <div style="height: 300px;">
                                <canvas id="activityHourlyStepsChart"></canvas>
                            </div>
                        </div>

                        <div class="resting-stat-card" style="padding: 24px;">
                            <h4 style="margin-bottom: 16px;">📈 每小时活动量分布</h4>
                            <div style="height: 300px;">
                                <canvas id="activityHourlyENMOChart"></canvas>
                            </div>
                        </div>

                        <div class="resting-stat-card" style="padding: 24px;">
                            <h4 style="margin-bottom: 16px;">🔥 每小时卡路里分布</h4>
                            <div style="height: 300px;">
                                <canvas id="activityHourlyCalorieChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <div class="resting-stat-card" style="padding: 24px;">
                            <h4 style="margin-bottom: 16px;">📉 实时活动强度趋势 (最近10分钟)</h4>
                            <div style="height: 300px;">
                                <canvas id="activityIntensityTrendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 日志区域 -->
                    <div class="resting-info-box">
                        <strong>📝 活动日志:</strong>
                        <div id="activityLog" style="max-height: 150px; overflow-y: auto; margin-top: 10px; font-family: monospace; font-size: 12px;">
                            等待开始监测...
                        </div>
                    </div>
                </div>
            </section>

            <!-- 睡眠质量监测模块 -->
            <section class="upload-section activity-section">
                <h2>😴 睡眠质量监测</h2>
                <p class="section-desc">
                    基于IMU加速度计数据，实时监测宠物睡眠状态，分析睡眠质量和睡眠周期
                </p>

                <!-- 控制按钮 -->
                <div class="file-actions">
                    <button class="btn btn-success" id="sleepStartBtn" onclick="startSleepMonitor()">
                        😴 开始睡眠监测
                    </button>
                    <button class="btn btn-danger" id="sleepStopBtn" onclick="stopSleepMonitor()" style="display:none;">
                        ⏹️ 停止监测
                    </button>
                    <button class="btn btn-secondary" onclick="resetSleepData()">
                        🔄 重置数据
                    </button>
                    <button class="btn btn-primary" onclick="generateSleepReport()">
                        📊 生成报告
                    </button>
                </div>

                <div class="resting-container">
                    <!-- 实时状态卡片 -->
                    <div class="resting-stats-grid">
                        <div class="resting-stat-card">
                            <div>当前状态</div>
                            <div id="sleepCurrentStage" class="resting-value">清醒</div>
                            <div id="sleepInBedStatus">未在床上</div>
                        </div>

                        <div class="resting-stat-card">
                            <div>睡眠时长</div>
                            <div id="sleepDuration" class="resting-value">0分钟</div>
                            <div id="sleepStartTime">未开始</div>
                        </div>

                        <div class="resting-stat-card">
                            <div>睡眠效率</div>
                            <div id="sleepEfficiency" class="resting-value">0%</div>
                            <div>睡眠质量指标</div>
                        </div>

                        <div class="resting-stat-card">
                            <div>翻身次数</div>
                            <div id="sleepTurnOverCount" class="resting-value">0次</div>
                            <div>体动频率</div>
                        </div>
                    </div>

                    <!-- 实时关键指标 -->
                    <div class="resting-info-box" style="grid-column: span 2; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <strong>📊 实时关键指标</strong>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px;">
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9;">RMS能量</div>
                                <div id="sleepCurrentRMS" style="font-size: 24px; font-weight: bold; margin: 5px 0;">0.000g</div>
                                <div id="sleepRMSStatus" style="font-size: 11px; opacity: 0.8;">静息</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9;">零交叉率</div>
                                <div id="sleepCurrentMCR" style="font-size: 24px; font-weight: bold; margin: 5px 0;">0.0次/秒</div>
                                <div id="sleepMCRStatus" style="font-size: 11px; opacity: 0.8;">低频</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9;">阶段持续</div>
                                <div id="sleepStageDuration" style="font-size: 24px; font-weight: bold; margin: 5px 0;">0分钟</div>
                                <div id="sleepLastStageChange" style="font-size: 11px; opacity: 0.8;">刚开始</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <div style="font-size: 12px; opacity: 0.9;">数据更新</div>
                                <div id="sleepDataRate" style="font-size: 24px; font-weight: bold; margin: 5px 0;">0 Hz</div>
                                <div id="sleepLastUpdate" style="font-size: 11px; opacity: 0.8;">等待数据</div>
                            </div>
                        </div>
                    </div>

                    <!-- 睡眠周期饼图 -->
                    <div class="resting-stat-card" style="grid-column: span 2;">
                        <h4>🌙 睡眠周期分布</h4>
                        <canvas id="sleepCycleChart" style="max-height: 300px;"></canvas>
                    </div>

                    <!-- 睡眠阶段时间线 -->
                    <div class="resting-stat-card" style="grid-column: span 2;">
                        <h4>📈 睡眠阶段时间线</h4>
                        <canvas id="sleepStageTimelineChart" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- RMS能量趋势 -->
                    <div class="resting-stat-card" style="grid-column: span 2;">
                        <h4>⚡ 运动强度趋势 (RMS)</h4>
                        <canvas id="sleepRMSChart" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- 睡眠统计信息 -->
                    <div class="resting-info-box" style="grid-column: span 2;">
                        <strong>📊 睡眠统计:</strong>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 10px;">
                            <div>
                                <div style="color: #5856D6; font-weight: bold;">深睡</div>
                                <div id="sleepDeepTime">0分钟</div>
                            </div>
                            <div>
                                <div style="color: #007AFF; font-weight: bold;">浅睡</div>
                                <div id="sleepLightTime">0分钟</div>
                            </div>
                            <div>
                                <div style="color: #FF9500; font-weight: bold;">REM</div>
                                <div id="sleepREMTime">0分钟</div>
                            </div>
                            <div>
                                <div style="color: #8E8E93; font-weight: bold;">清醒</div>
                                <div id="sleepAwakeTime">0分钟</div>
                            </div>
                        </div>
                    </div>

                    <!-- 日志区域 -->
                    <div class="resting-info-box" style="grid-column: span 2;">
                        <strong>📝 睡眠事件:</strong>
                        <div id="sleepEventLog" style="max-height: 150px; overflow-y: auto; margin-top: 10px; font-family: monospace; font-size: 12px;">
                            等待开始监测...
                        </div>
                    </div>
                </div>
            </section>

            <!-- 文件上传区域 -->
            <section class="upload-section">
                <h2>📁 数据文件上传</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <div class="upload-icon">📤</div>
                        <p>拖拽文件到此处或点击选择文件</p>
                        <p class="upload-hint">支持 .txt 格式的雷达数据文件 或 .json 格式的结构化数据文件</p>
                        <input type="file" id="fileInput" accept=".txt,.json" multiple>
                    </div>
                </div>
                
                <!-- 文件列表 -->
                <div class="file-list" id="fileList" style="display: none;">
                    <h3>已选择的文件:</h3>
                    <ul id="fileItems"></ul>
                    <div class="file-actions">
                        <button class="btn btn-primary" onclick="processFiles()">开始处理</button>
                        <button class="btn btn-secondary" onclick="clearFiles()">清空文件</button>
                    </div>
                </div>
            </section>

            <!-- 处理状态 -->
            <section class="status-section" id="statusSection" style="display: none;">
                <h2>⚙️ 处理状态</h2>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">准备中...</div>
                </div>
                <div class="status-log" id="statusLog"></div>
            </section>

            <!-- 处理结果 -->
            <section class="results-section" id="resultsSection" style="display: none;">
                <h2>📊 处理结果</h2>

                <!-- JSON数据详细信息 -->
                <div class="json-data-section" id="jsonDataSection" style="display: none; margin-bottom: 20px;">
                    <h3>🐾 宠物信息</h3>
                    <div class="animal-info-card" id="animalInfoCard">
                        <div class="animal-header">
                            <div class="animal-avatar">
                                <span id="animalEmoji">🐕</span>
                            </div>
                            <div class="animal-details">
                                <h4 id="animalName">宠物名称</h4>
                                <p id="animalBasicInfo">品种 · 年龄 · 性别</p>
                            </div>
                        </div>
                        <div class="animal-stats">
                            <div class="stat-item">
                                <span class="stat-label">体重</span>
                                <span class="stat-value" id="animalWeight">-- kg</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">设备ID</span>
                                <span class="stat-value" id="animalId">--</span>
                            </div>
                        </div>
                    </div>

                    <h3>📱 设备信息</h3>
                    <div class="device-info-card" id="deviceInfoCard">
                        <div class="device-details">
                            <div class="device-item">
                                <span class="device-label">设备ID:</span>
                                <span class="device-value" id="deviceId">--</span>
                            </div>
                            <div class="device-item">
                                <span class="device-label">固件版本:</span>
                                <span class="device-value" id="deviceFirmware">--</span>
                            </div>
                            <div class="device-item">
                                <span class="device-label">采样频率:</span>
                                <span class="device-value" id="deviceSampling">--</span>
                            </div>
                        </div>
                    </div>

                    <h3>📍 测量信息</h3>
                    <div class="measurement-info-card" id="measurementInfoCard">
                        <div class="measurement-details">
                            <div class="measurement-item">
                                <span class="measurement-label">事件ID:</span>
                                <span class="measurement-value" id="eventId">--</span>
                            </div>
                            <div class="measurement-item">
                                <span class="measurement-label">测量时间:</span>
                                <span class="measurement-value" id="measurementTime">--</span>
                            </div>
                            <div class="measurement-item">
                                <span class="measurement-label">测量时长:</span>
                                <span class="measurement-value" id="measurementDuration">--</span>
                            </div>
                            <div class="measurement-item">
                                <span class="measurement-label">位置:</span>
                                <span class="measurement-value" id="measurementLocation">--</span>
                            </div>
                            <div class="measurement-item">
                                <span class="measurement-label">备注:</span>
                                <span class="measurement-value" id="measurementNotes">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- 健康分析区域 -->
                    <div class="health-analysis-section" id="healthAnalysisSection" style="display: none; margin-top: 20px;">
                        <h3>🏥 宠物健康智能分析</h3>
                        <div class="health-analysis-controls">
                            <button class="btn btn-success" onclick="performHealthAnalysis()" id="healthAnalysisBtn">
                                🩺 开始健康分析
                            </button>
                            <div class="analysis-config" style="margin-top: 10px;">
                                <label for="agentEndpoint">Agent API地址:</label>
                                <input type="text" id="agentEndpoint" placeholder="http://localhost:8000" style="margin-left: 10px; width: 200px;">
                            </div>
                        </div>

                        <div class="health-analysis-report" id="healthAnalysisReport" style="display: none; margin-top: 20px;">
                            <div class="report-header">
                                <h4>📋 健康分析报告</h4>
                                <div class="report-meta">
                                    <span id="analysisTimestamp"></span>
                                    <button class="btn btn-sm" onclick="exportHealthReport()">📄 导出报告</button>
                                </div>
                            </div>
                            <div class="report-content" id="analysisReportContent">
                                <div class="loading-analysis" id="analysisLoading">
                                    <div class="loading-spinner"></div>
                                    <p>正在分析宠物健康状况，请稍候...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 结果统计 -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">💓</div>
                        <div class="stat-content">
                            <div class="stat-label">平均心率</div>
                            <div class="stat-value" id="avgHeartRate">-- bpm</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🫁</div>
                        <div class="stat-content">
                            <div class="stat-label">平均呼吸频率</div>
                            <div class="stat-value" id="avgRespRate">-- bpm</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📁</div>
                        <div class="stat-content">
                            <div class="stat-label">处理文件数</div>
                            <div class="stat-value" id="processedFiles">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📈</div>
                        <div class="stat-content">
                            <div class="stat-label">总数据点</div>
                            <div class="stat-value" id="totalDataPoints">0</div>
                        </div>
                    </div>
                </div>

                <!-- 图表区域 -->
                <div class="charts-container">
                    <div class="chart-row">
                        <div class="chart-container">
                            <h3>I 通道信号</h3>
                            <canvas id="iSignalChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Q 通道信号</h3>
                            <canvas id="qSignalChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-container">
                            <h3>I/Q星座图</h3>
                            <canvas id="constellationChart"></canvas>
                        </div>
                        <!-- 占位，保持布局 -->
                        <div class="chart-container" style="visibility: hidden;"></div>
                    </div>
                    
                    <div class="chart-row">
                        <div class="chart-container">
                            <h3>呼吸波形</h3>
                            <canvas id="respiratoryChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>心跳波形</h3>
                            <canvas id="heartbeatChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 动态心电图展示区域 -->
                    <div class="ecg-section">
                        <h3>🫀 动态生理信号监测</h3>
                        <div class="ecg-controls">
                            <button class="btn btn-success" id="playBtn" onclick="toggleECGPlayback()">▶️ 播放</button>
                            <button class="btn btn-secondary" id="pauseBtn" onclick="toggleECGPlayback()" style="display: none;">⏸️ 暂停</button>
                            <button class="btn btn-info" onclick="resetECG()">🔄 重置</button>
                            <button class="btn btn-warning" onclick="testECG()" style="background: #ffc107; color: #000;">🧪 测试</button>
                            <div class="speed-control">
                                <label>播放速度:</label>
                                <select id="speedSelect" onchange="changeECGSpeed()">
                                    <option value="0.5">0.5x</option>
                                    <option value="1" selected>1x</option>
                                    <option value="2">2x</option>
                                    <option value="4">4x</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="ecg-monitors">
                            <!-- 呼吸波形动态监测 -->
                            <div class="ecg-monitor respiratory-monitor">
                                <div class="monitor-header">
                                    <h4>🫁 呼吸波形</h4>
                                    <div class="vital-display">
                                        <span class="vital-label">呼吸频率:</span>
                                        <span class="vital-value" id="currentRespRate">-- bpm</span>
                                    </div>
                                </div>
                                <div class="ecg-screen" id="respiratoryECG">
                                    <canvas id="respiratoryECGCanvas"></canvas>
                                    <div class="ecg-grid"></div>
                                    <div class="ecg-cursor"></div>
                                </div>
                            </div>
                            
                            <!-- 心跳波形动态监测 -->
                            <div class="ecg-monitor heartbeat-monitor">
                                <div class="monitor-header">
                                    <h4>💓 心跳波形</h4>
                                    <div class="vital-display">
                                        <span class="vital-label">心率:</span>
                                        <span class="vital-value" id="currentHeartRate">-- bpm</span>
                                    </div>
                                </div>
                                <div class="ecg-screen" id="heartbeatECG">
                                    <canvas id="heartbeatECGCanvas"></canvas>
                                    <div class="ecg-grid"></div>
                                    <div class="ecg-cursor"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-row">
                        <div class="chart-container">
                            <h3>心率时间序列</h3>
                            <canvas id="heartRateTimeChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>呼吸频率时间序列</h3>
                            <canvas id="respRateTimeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-row">
                        <div class="chart-container">
                            <h3>心率分布</h3>
                            <canvas id="heartRateChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>呼吸频率分布</h3>
                            <canvas id="respRateChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- AI诊断报告区域 -->
                <div class="ai-diagnosis-section">
                    <h3>🤖 AI智能诊断报告</h3>
                    <div class="ai-controls">
                        <button class="btn btn-primary" onclick="showAIConfig()">⚙️ 配置Azure OpenAI</button>
                        <button class="btn btn-success" onclick="generateDiagnosticReport()" id="generateReportBtn" disabled>🩺 生成诊断报告</button>
                        <button class="btn btn-info" onclick="showPromptEditor()">📝 自定义Prompt</button>
                        <button class="btn btn-warning" onclick="showRAGEditor()">📚 管理知识库</button>
                    </div>
                    
                    <div class="ai-report-container" id="aiReportContainer" style="display: none;">
                        <div class="report-header">
                            <h4>诊断报告</h4>
                            <div class="report-meta">
                                <span id="reportTimestamp"></span>
                                <button class="btn btn-sm" onclick="exportReport()">📄 导出报告</button>
                            </div>
                        </div>
                        <div class="report-content" id="reportContent"></div>
                    </div>
                </div>

                <!-- 详细结果表格 -->
                <div class="table-container">
                    <h3>详细处理结果</h3>
                    <div class="table-actions">
                        <button class="btn btn-success" onclick="exportResults()">导出CSV</button>
                        <button class="btn btn-info" onclick="exportCharts()">导出图表</button>
                    </div>
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>数据点数</th>
                                <th>心率 (bpm)</th>
                                <th>呼吸频率 (bpm)</th>
                                <th>圆心I</th>
                                <th>圆心Q</th>
                                <th>圆半径</th>
                                <th>处理状态</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 蓝牙实时图表区域 -->
            <section class="results-section" id="bluetoothChartsSection" style="display: none;">
                <h2>📊 蓝牙实时数据图表</h2>
                
                <!-- 蓝牙数据统计 -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">💓</div>
                        <div class="stat-content">
                            <div class="stat-label">实时心率</div>
                            <div class="stat-value" id="bleAvgHeartRate">-- bpm</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🫁</div>
                        <div class="stat-content">
                            <div class="stat-label">实时呼吸频率</div>
                            <div class="stat-value" id="bleAvgRespRate">-- bpm</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📡</div>
                        <div class="stat-content">
                            <div class="stat-label">接收数据点</div>
                            <div class="stat-value" id="bleTotalDataPoints">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">⏱️</div>
                        <div class="stat-content">
                            <div class="stat-label">连接时长</div>
                            <div class="stat-value" id="bleConnectTime">0 分钟</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">🌡️</div>
                        <div class="stat-content">
                            <div class="stat-label">当前温度</div>
                            <div class="stat-value" id="bleAvgTemp">-- °C</div>
                        </div>
                    </div>
                </div>

                <!-- 蓝牙图表区域 -->
                <div class="charts-container">
                    <div class="chart-row">
                        <div class="chart-container">
                            <h3>蓝牙 I 通道实时信号</h3>
                            <canvas id="bleISignalChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>蓝牙 Q 通道实时信号</h3>
                            <canvas id="bleQSignalChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-container">
                            <h3>蓝牙 I/Q 星座图</h3>
                            <canvas id="bleConstellationChart"></canvas>
                        </div>
                        <!-- 占位 -->
                        <div class="chart-container" style="visibility: hidden;"></div>
                    </div>

                    <div class="chart-row">
                        <div class="chart-container">
                            <h3>蓝牙 Gx/Gy/Gz 信号(陀螺仪)</h3>
                            <canvas id="bleIMUChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>蓝牙 温度变化 (°C)</h3>
                            <canvas id="bleTemperatureChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-row">
                        <div class="chart-container">
                            <h3>蓝牙呼吸波形</h3>
                            <canvas id="bleRespiratoryChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>蓝牙心跳波形</h3>
                            <canvas id="bleHeartbeatChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 蓝牙动态生理信号监测（与文件上传模块等效） -->
                <div class="ecg-section" id="bleEcgSection">
                    <h3>🫀 蓝牙动态生理信号监测</h3>
                    <div class="ecg-controls">
                        <button class="btn btn-success" id="blePlayBtn" onclick="toggleBLEECGPlayback()">▶️ 播放</button>
                        <button class="btn btn-secondary" id="blePauseBtn" onclick="toggleBLEECGPlayback()" style="display: none;">⏸️ 暂停</button>
                        <button class="btn btn-info" onclick="resetBLEECG()">🔄 重置</button>
                    </div>

                    <div class="ecg-monitors">
                        <div class="ecg-monitor respiratory-monitor">
                            <div class="monitor-header">
                                <h4>🫁 呼吸波形(蓝牙)</h4>
                                <div class="vital-display">
                                    <span class="vital-label">呼吸频率:</span>
                                    <span class="vital-value" id="bleCurrentRespRate">-- bpm</span>
                                </div>
                            </div>
                            <div class="ecg-screen" id="bleRespiratoryECG">
                                <canvas id="bleRespiratoryECGCanvas"></canvas>
                                <div class="ecg-grid"></div>
                                <div class="ecg-cursor"></div>
                            </div>
                        </div>

                        <div class="ecg-monitor heartbeat-monitor">
                            <div class="monitor-header">
                                <h4>💓 心跳波形(蓝牙)</h4>
                                <div class="vital-display">
                                    <span class="vital-label">心率:</span>
                                    <span class="vital-value" id="bleCurrentHeartRate">-- bpm</span>
                                </div>
                            </div>
                            <div class="ecg-screen" id="bleHeartbeatECG">
                                <canvas id="bleHeartbeatECGCanvas"></canvas>
                                <div class="ecg-grid"></div>
                                <div class="ecg-cursor"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 蓝牙图表控制 -->
                <div class="table-container">
                    <h3>蓝牙数据控制</h3>
                    <div class="table-actions">
                        <button class="btn btn-warning" onclick="clearBluetoothData()">清空数据</button>
                        <button class="btn btn-info" onclick="saveBluetoothData()">保存数据</button>
                        <button class="btn btn-purple" onclick="if(app) app.forceReinitializeCharts();">重新初始化图表</button>
                        <button class="btn btn-info" onclick="if(app) app.resetAdaptiveYAxis();">重置自适应Y轴</button>
                        <button class="btn btn-success" onclick="if(app) app.forceDetailMode();">强制细节模式</button>
                        <button class="btn btn-secondary" onclick="hideBluetoothCharts()">隐藏图表</button>
                    </div>
                </div>
            </section>

            <!-- 宠物健康对话区域 -->
            <section class="upload-section health-chat-section" id="healthChatSection">
                <div class="health-chat-header">
                    <div class="health-chat-title">
                        <h2>💬 宠物健康智能对话</h2>
                        <p class="health-chat-subtitle">
                            与 AI 助手对话，获取宠物健康相关的专业建议和解答
                        </p>
                    </div>

                    <div class="health-chat-toolbar">
                        <div class="health-chat-endpoint" title="连接状态">
                            <span class="status-dot disconnected" id="chatAgentStatusDot"></span>
                            <span class="status-text" id="chatAgentStatusText">未连接</span>
                            <span class="endpoint-mono" id="chatAgentEndpointText" style="display:none;"></span>
                        </div>

                        <div class="health-chat-actions">
                            <button class="btn btn-primary" onclick="initializeHealthChat()" id="initChatBtn">🔄 重新连接</button>
                            <button class="btn btn-secondary" onclick="clearChatHistory()" id="clearChatBtn">🗑️ 清空对话</button>
                        </div>
                    </div>
                </div>

                <!-- 对话界面（固定使用内置Agent地址，无需手动输入） -->
                <div class="chat-container" id="chatContainer">
                    <div class="chat-messages" id="chatMessages">
                        <div class="welcome-message">
                            <div class="message-avatar">🤖</div>
                            <div class="message-content">
                                <div class="message-text">
                                    您好！我是宠物健康助手，可以帮您解答关于宠物健康、护理、训练等方面的问题。
                                    请告诉我您的宠物信息和想要咨询的问题。
                                </div>
                                <div class="message-time">系统消息</div>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <div class="chat-input-container">
                            <textarea id="chatInput" placeholder="输入您的问题...（Enter发送，Shift+Enter换行）" rows="2"></textarea>
                            <button class="btn btn-success" onclick="sendChatMessage()" id="sendChatBtn" disabled>发送</button>
                        </div>
                        <div class="chat-tips">
                            💡 提示：您可以询问宠物的饮食、运动、行为、疾病预防等问题
                        </div>
                    </div>
                </div>
            </section>

        </div>

        <!-- 算法参数设置 -->
        <aside class="settings-panel" id="settingsPanel">
            <h3>⚙️ 算法参数</h3>
            <div class="setting-group">
                <label>采样率 (Hz):</label>
                <input type="number" id="samplingRate" value="50" min="1" max="1000">
            </div>
            <div class="setting-group">
                <label>心率范围 (bpm):</label>
                <input type="number" id="heartRateMin" value="48" min="30" max="100" placeholder="最小值">
                <input type="number" id="heartRateMax" value="180" min="100" max="300" placeholder="最大值">
            </div>
            <div class="setting-group">
                <label>呼吸频率范围 (bpm):</label>
                <input type="number" id="respRateMin" value="6" min="3" max="15" placeholder="最小值">
                <input type="number" id="respRateMax" value="30" min="15" max="60" placeholder="最大值">
            </div>
            <div class="setting-group">
                <label>滤波窗口大小:</label>
                <input type="number" id="filterWindow" value="10" min="3" max="50">
            </div>
            <div class="setting-group">
                <label>心率平滑长度:</label>
                <input type="number" id="heartRateSmoothing" value="30" min="5" max="60" title="保留最近N次心率结果取平均，值越大越平滑但响应越慢">
            </div>
            <div class="setting-group">
                <label>心率变化阈值(bpm):</label>
                <input type="number" id="heartRateDelta" value="10" min="5" max="30" title="限制心率每次最大变化幅度，防止突变">
            </div>
            <button class="btn btn-primary" onclick="applySettings()">应用设置</button>
        </aside>

        <!-- 设置按钮 -->
        <button class="settings-toggle" onclick="toggleSettings()">⚙️</button>
    </div>

    <!-- 加载指示器 -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">正在处理数据...</div>
    </div>

    <!-- Azure OpenAI配置模态框 -->
    <div class="modal" id="aiConfigModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>配置Azure OpenAI</h3>
                <span class="close" onclick="closeModal('aiConfigModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Azure OpenAI Endpoint:</label>
                    <input type="text" id="azureEndpoint" placeholder="https://your-resource.openai.azure.com">
                </div>
                <div class="form-group">
                    <label>API Key:</label>
                    <input type="password" id="azureApiKey" placeholder="输入您的API密钥">
                </div>
                <div class="form-group">
                    <label>Deployment Name:</label>
                    <input type="text" id="azureDeployment" placeholder="gpt-4" value="gpt-4">
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="saveAIConfig()">保存配置</button>
                    <button class="btn btn-secondary" onclick="testAIConnection()">测试连接</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt编辑器模态框 -->
    <div class="modal" id="promptEditorModal" style="display: none;">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>自定义Prompt编辑器</h3>
                <span class="close" onclick="closeModal('promptEditorModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="prompt-selector">
                    <label>选择Prompt模板:</label>
                    <select id="promptSelector" onchange="loadPromptTemplate()">
                        <option value="">-- 选择模板 --</option>
                    </select>
                    <button class="btn btn-sm" onclick="createNewPrompt()">新建</button>
                </div>
                
                <div class="form-group">
                    <label>Prompt名称:</label>
                    <input type="text" id="promptName" placeholder="输入Prompt名称">
                </div>
                
                <div class="form-group">
                    <label>描述:</label>
                    <input type="text" id="promptDescription" placeholder="简要描述这个Prompt的用途">
                </div>
                
                <div class="form-group">
                    <label>Prompt模板:</label>
                    <textarea id="promptTemplate" rows="15" placeholder="输入您的自定义prompt模板...

可用变量：
{avgHeartRate} - 平均心率
{avgRespiratoryRate} - 平均呼吸频率
{heartRateRange} - 心率范围
{heartRateVariability} - 心率变异性
{heartRateData} - 心率数据
{respiratoryData} - 呼吸数据
{ragContext} - RAG检索的相关知识
{measurementTime} - 测量时间
{duration} - 测量时长
{dataQuality} - 数据质量"></textarea>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="savePrompt()">保存Prompt</button>
                    <button class="btn btn-warning" onclick="deletePrompt()">删除</button>
                    <button class="btn btn-info" onclick="previewPrompt()">预览</button>
                </div>
            </div>
        </div>
    </div>

    <!-- RAG知识库编辑器模态框 -->
    <div class="modal" id="ragEditorModal" style="display: none;">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>RAG知识库管理</h3>
                <span class="close" onclick="closeModal('ragEditorModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="rag-controls">
                    <button class="btn btn-primary" onclick="addRAGEntry()">添加知识条目</button>
                    <button class="btn btn-info" onclick="importRAGData()">导入知识库</button>
                    <button class="btn btn-success" onclick="exportRAGData()">导出知识库</button>
                </div>
                
                <div class="rag-list" id="ragList">
                    <!-- RAG条目列表将在这里动态生成 -->
                </div>
                
                <div class="rag-editor" id="ragEditor" style="display: none;">
                    <h4>编辑知识条目</h4>
                    <div class="form-group">
                        <label>条目ID:</label>
                        <input type="text" id="ragEntryId" placeholder="唯一标识符">
                    </div>
                    <div class="form-group">
                        <label>关键词 (用逗号分隔):</label>
                        <input type="text" id="ragKeywords" placeholder="心率,呼吸,正常范围">
                    </div>
                    <div class="form-group">
                        <label>知识内容:</label>
                        <textarea id="ragContent" rows="10" placeholder="输入相关的医学知识内容..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="saveRAGEntry()">保存</button>
                        <button class="btn btn-secondary" onclick="cancelRAGEdit()">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="radar-processor.js?v=20260129-1"></script>
    <script src="azure-gpt.js?v=20260129-1"></script>
    <script src="resting-monitor.js?v=20260129-1"></script>
    <script src="activity-monitor.js?v=20260129-1"></script>
    <script src="sleep-monitor.js?v=20260129-1"></script>
    <!-- Markdown 渲染（marked）+ 安全净化（DOMPurify） -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <script src="app.js?v=20260129-1"></script>

    <!-- BLE调试代码 -->
    <script>
        window.addEventListener('load', function() {
            console.log('🔍 BLE调试信息:');
            console.log('window.BLE存在:', typeof window.BLE);
            if (window.BLE) {
                console.log('BLE对象属性:', Object.keys(window.BLE));
                console.log('BLE.connect方法:', typeof window.BLE.connect);
            }

            console.log('window.app存在:', typeof window.app);
            if (window.app) {
                console.log('app.processor存在:', typeof window.app.processor);
                if (window.app.processor) {
                    console.log('processor.fs:', window.app.processor.fs);
                }
            }

            // 测试BLE连接按钮
            const bleBtn = document.getElementById('bleConnectBtn');
            if (bleBtn) {
                console.log('BLE连接按钮找到:', bleBtn);
                console.log('按钮onclick属性:', bleBtn.getAttribute('onclick'));
                console.log('按钮onclick函数:', bleBtn.onclick);
                console.log('bleConnect函数存在:', typeof window.bleConnect);
            } else {
                console.error('BLE连接按钮未找到!');
            }

            // 测试手动调用
            if (window.bleConnect) {
                console.log('bleConnect函数可以调用');
                // 如果BLE对象不存在，尝试重新创建
                if (!window.BLE) {
                    console.warn('BLE对象不存在，尝试重新创建...');
                    try {
                        // 重新执行bluetooth.js的内容
                        const script = document.createElement('script');
                        script.src = 'bluetooth.js?v=' + Date.now();
                        document.head.appendChild(script);
                        script.onload = function() {
                            console.log('BLE对象重新创建完成:', typeof window.BLE);
                        };
                    } catch (e) {
                        console.error('重新创建BLE失败:', e);
                    }
                }
            } else {
                console.error('bleConnect函数不存在!');
            }
        });
    </script>
</body>
</html>
