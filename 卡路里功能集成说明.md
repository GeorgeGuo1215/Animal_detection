# 卡路里计算功能集成说明

## 📋 功能概述

基于`卡路里.py`中的算法，已成功将卡路里计算功能集成到Web活动监测模块中。

## 🔧 核心算法

### 1. 基础代谢率 (RER - Resting Energy Requirement)

```javascript
RER = 70 × 体重^0.75 (kcal/day)
BMR_per_sec = RER / 86400
```

**示例**：
- 10kg宠物: RER = 70 × 10^0.75 ≈ 394 kcal/day
- 每秒基础代谢: 394 / 86400 ≈ 0.00456 kcal/sec

### 2. METs (代谢当量) 映射

根据ENMO值动态计算METs：

| ENMO范围 | METs | 活动类型 |
|---------|------|---------|
| < 0.05 | 1.0 | 静息 |
| 0.05 - 0.20 | 2.0 | 轻微活动/慢走 |
| 0.20 - 0.50 | 4.0 | 中度活动/小跑 |
| > 0.50 | 6.0 | 剧烈活动/狂奔 |

### 3. 卡路里计算公式

```javascript
Calories = BMR_per_sec × METs × duration
```

**示例** (10kg宠物，1秒数据):
- 静息: 0.00456 × 1.0 × 1 = 0.00456 kcal
- 慢走: 0.00456 × 2.0 × 1 = 0.00912 kcal
- 小跑: 0.00456 × 4.0 × 1 = 0.01824 kcal
- 狂奔: 0.00456 × 6.0 × 1 = 0.02736 kcal

## 📝 代码修改清单

### 1. activity-monitor.js

#### 构造函数更新
```javascript
constructor(samplingRate = 50, petWeight = 10.0) {
    this.petWeight = petWeight;
    this.rerDaily = 70 * Math.pow(petWeight, 0.75);
    this.bmrPerSec = this.rerDaily / 86400.0;
    this.totalCalories = 0;
    this.calorieGoal = 100;
    this.currentMETs = 1.0;
    // ...
}
```

#### calculateActivityMetrics方法
添加METs和卡路里计算：
```javascript
let mets = 1.0;
if (enmo > 0.50) mets = 6.0;
else if (enmo > 0.20) mets = 4.0;
else if (enmo > 0.05) mets = 2.0;

const duration = n / this.fs;
const calories = this.bmrPerSec * mets * duration;

return { enmo, mad, intensity, mets, calories, svm };
```

#### processActivityMetrics方法
累加卡路里：
```javascript
this.totalCalories += metrics.calories;
this.currentMETs = metrics.mets;
```

#### 图表初始化
添加卡路里环形图：
```javascript
this.charts.calorieRing = new Chart(calorieRingCtx, {
    type: 'doughnut',
    data: {
        datasets: [{
            data: [0, 100],
            backgroundColor: ['#FF9500', '#E5E5EA']
        }]
    }
});
```

#### 数据结构更新
- `hourlyData`: 添加`calories`字段
- `activityHistory`: 添加`mets`和`calories`字段
- `getSummary()`: 添加卡路里相关信息

### 2. index.html

#### 输入控件
```html
<label>宠物体重(kg):</label>
<input type="number" id="petWeight" value="10.0" min="1" max="100" step="0.5">

<label>卡路里目标(kcal):</label>
<input type="number" id="activityCalorieGoal" value="100" min="10" max="500" step="10">
```

#### 卡路里环形图卡片
```html
<div class="resting-stat-card">
    <div>卡路里消耗</div>
    <canvas id="activityCalorieRingChart"></canvas>
    <div id="activityCaloriePercent">0%</div>
    <div id="activityTotalCalories">0.00</div>
    <div>目标: <span id="displayCalorieGoal">100</span> kcal</div>
    <div>METs: <span id="activityCurrentMETs">1.0</span></div>
</div>
```

#### 信息显示卡片
添加体重、RER显示：
```html
<div>宠物体重</div>
<div id="activityPetWeight">10.0 kg</div>
<div>基础代谢(RER)</div>
<div id="activityRER">0 kcal/day</div>
```

### 3. app.js

#### startActivityMonitor函数
```javascript
const petWeight = parseFloat(document.getElementById('petWeight').value) || 10.0;
const calorieGoal = parseFloat(document.getElementById('activityCalorieGoal').value) || 100;

app.activityMonitor = new ActivityMonitor(app.processor.fs, petWeight);
app.activityMonitor.calorieGoal = calorieGoal;
```

#### updateActivityGoals函数
```javascript
const petWeight = parseFloat(document.getElementById('petWeight').value) || 10.0;
const calorieGoal = parseFloat(document.getElementById('activityCalorieGoal').value) || 100;

app.activityMonitor.petWeight = petWeight;
app.activityMonitor.rerDaily = 70 * Math.pow(petWeight, 0.75);
app.activityMonitor.bmrPerSec = app.activityMonitor.rerDaily / 86400.0;
app.activityMonitor.calorieGoal = calorieGoal;
```

## 🎯 预期效果

### 不同体重宠物的RER

| 体重 | RER (kcal/day) | BMR (kcal/sec) |
|------|---------------|----------------|
| 5kg | 234 | 0.00271 |
| 10kg | 394 | 0.00456 |
| 20kg | 662 | 0.00766 |
| 30kg | 897 | 0.01038 |

### 卡路里消耗示例 (10kg宠物)

**1分钟活动**:
- 静息: 0.00456 × 1.0 × 60 = 0.27 kcal
- 慢走: 0.00456 × 2.0 × 60 = 0.55 kcal
- 小跑: 0.00456 × 4.0 × 60 = 1.09 kcal
- 狂奔: 0.00456 × 6.0 × 60 = 1.64 kcal

**1小时活动**:
- 静息: 0.27 × 60 = 16.4 kcal
- 慢走: 0.55 × 60 = 32.8 kcal
- 小跑: 1.09 × 60 = 65.6 kcal
- 狂奔: 1.64 × 60 = 98.4 kcal

### 合理的每日目标

| 活动水平 | 卡路里目标 | 说明 |
|---------|-----------|------|
| 低活动 | 50-100 kcal | 主要静息，少量轻度活动 |
| 中等活动 | 100-200 kcal | 每天1-2小时中度活动 |
| 高活动 | 200-300 kcal | 每天2-3小时剧烈活动 |

## 🧪 测试步骤

### 1. 刷新浏览器
```
Cmd+Shift+R (Mac) 或 Ctrl+Shift+R (Windows)
```

### 2. 设置参数
- 宠物体重: 10.0 kg
- 步数目标: 1000
- 活动量目标: 2.0
- 卡路里目标: 100 kcal

### 3. 开始监测
1. 连接蓝牙
2. 点击"开始活动监测"
3. 观察卡路里环形图和数值

### 4. 验证计算

**静息1分钟**:
- 预期卡路里: ~0.27 kcal
- METs: 1.0

**慢走1分钟**:
- 预期卡路里: ~0.55 kcal
- METs: 2.0

**快走1分钟**:
- 预期卡路里: ~1.09 kcal
- METs: 4.0

**剧烈运动1分钟**:
- 预期卡路里: ~1.64 kcal
- METs: 6.0

## 📊 控制台输出示例

```
📊 [5秒] ENMO=0.0678, MAD=0.0876, 强度=light, METs=2.0, 卡路里=0.0046, 新步数=0, 总步数=0
📊 [10秒] ENMO=0.1356, MAD=0.2489, 强度=moderate, METs=2.0, 卡路里=0.0091, 新步数=2, 总步数=2
📊 [15秒] ENMO=0.3384, MAD=0.4481, 强度=vigorous, METs=4.0, 卡路里=0.0182, 新步数=3, 总步数=5
```

## 🎨 UI显示

### 卡路里环形图
- 颜色: 橙色 (#FF9500)
- 显示: 百分比、总卡路里、目标、METs

### 信息卡片
- 宠物体重: 10.0 kg
- 基础代谢(RER): 394 kcal/day
- 当前METs: 1.0 - 6.0
- 最后更新时间

## ✅ 功能特性

1. **实时卡路里计算**: 每秒更新一次
2. **动态METs映射**: 根据ENMO自动调整
3. **体重可调**: 支持1-100kg范围
4. **目标跟踪**: 环形图显示完成度
5. **历史记录**: 每小时卡路里统计
6. **基础代谢显示**: 显示RER和BMR

## 🔍 调试信息

### 查看当前状态
```javascript
// 在浏览器控制台执行
const summary = app.activityMonitor.getSummary();
console.log('卡路里:', summary.totalCalories);
console.log('METs:', summary.currentMETs);
console.log('RER:', summary.rerDaily);
console.log('体重:', summary.petWeight);
```

### 手动测试卡路里计算
```javascript
// 模拟1分钟慢走
const monitor = app.activityMonitor;
const expectedCalories = monitor.bmrPerSec * 2.0 * 60;
console.log('预期卡路里:', expectedCalories.toFixed(4));
```

## 📌 注意事项

1. **体重单位**: 必须使用kg，不支持磅
2. **卡路里单位**: kcal (千卡)，不是cal
3. **METs阈值**: 基于ENMO值，可根据实际情况调整
4. **目标设置**: 建议根据宠物品种和活动水平设置
5. **累加方式**: 包括静息状态的基础代谢

## 🚀 未来优化建议

1. **品种预设**: 不同品种的默认体重和目标
2. **年龄因子**: 考虑年龄对代谢率的影响
3. **温度补偿**: 环境温度对能量消耗的影响
4. **活动识别**: 区分走路、跑步、跳跃等不同活动
5. **营养建议**: 基于消耗推荐食物摄入量

---

**版本**: 1.4.0
**更新时间**: 2026-01-27
**状态**: 卡路里功能已完整集成
