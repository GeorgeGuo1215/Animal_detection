# 卡路里功能页面更新验证

## ✅ 已完成的更新

### 1. HTML页面 (index.html)

#### 新增输入控件
```html
<label>宠物体重(kg):</label>
<input type="number" id="petWeight" value="10.0" min="1" max="100" step="0.5">

<label>卡路里目标(kcal):</label>
<input type="number" id="activityCalorieGoal" value="100" min="10" max="500" step="10">
```

#### 新增卡路里环形图卡片
```html
<div class="resting-stat-card">
    <div>卡路里消耗</div>
    <canvas id="activityCalorieRingChart"></canvas>
    <div id="activityCaloriePercent">0%</div>
    <div id="activityTotalCalories">0.00</div>
    <div>目标: <span id="displayCalorieGoal">100</span> kcal</div>
    <div>METs: <span id="activityCurrentMETs">1.0</span></div>
</div>
```

#### 新增每小时卡路里分布图
```html
<div class="resting-stat-card">
    <h4>🔥 每小时卡路里分布</h4>
    <canvas id="activityHourlyCalorieChart"></canvas>
</div>
```

#### 更新信息显示卡片
```html
<div>宠物体重</div>
<div id="activityPetWeight">10.0 kg</div>
<div>基础代谢(RER)</div>
<div id="activityRER">0 kcal/day</div>
```

### 2. JavaScript逻辑 (activity-monitor.js)

#### 构造函数
- ✅ 添加 `petWeight` 参数
- ✅ 计算 `rerDaily` (RER)
- ✅ 计算 `bmrPerSec` (每秒基础代谢)
- ✅ 添加 `totalCalories` 累计变量
- ✅ 添加 `calorieGoal` 目标变量
- ✅ 添加 `currentMETs` 当前代谢当量

#### calculateActivityMetrics方法
- ✅ 根据ENMO计算METs
- ✅ 计算卡路里: `BMR × METs × duration`
- ✅ 返回 `mets` 和 `calories`

#### processActivityMetrics方法
- ✅ 累加卡路里: `this.totalCalories += metrics.calories`
- ✅ 更新当前METs: `this.currentMETs = metrics.mets`
- ✅ 记录历史数据包含 `mets` 和 `calories`

#### updateHourlyStats方法
- ✅ 累加每小时卡路里: `this.hourlyData[hour].calories += calories`

#### initializeCharts方法
- ✅ 初始化卡路里环形图 (橙色 #FF9500)
- ✅ 初始化每小时卡路里柱状图

#### updateCharts方法
- ✅ 更新卡路里环形图百分比
- ✅ 更新每小时卡路里柱状图数据

#### updateStatistics方法
- ✅ 更新总卡路里显示: `activityTotalCalories`
- ✅ 更新卡路里百分比: `activityCaloriePercent`
- ✅ 更新METs显示: `activityCurrentMETs`
- ✅ 更新体重显示: `activityPetWeight`
- ✅ 更新RER显示: `activityRER`

#### resetDailyData方法
- ✅ 重置 `totalCalories = 0`
- ✅ 重置每小时数据的 `calories` 字段

#### getSummary方法
- ✅ 返回 `totalCalories`
- ✅ 返回 `petWeight`
- ✅ 返回 `rerDaily`
- ✅ 返回 `currentMETs`
- ✅ 返回 `calorieGoalPercent`

### 3. 应用逻辑 (app.js)

#### startActivityMonitor函数
- ✅ 读取体重输入: `petWeight`
- ✅ 读取卡路里目标: `calorieGoal`
- ✅ 创建ActivityMonitor时传递体重参数
- ✅ 设置卡路里目标

#### updateActivityGoals函数
- ✅ 读取体重输入
- ✅ 读取卡路里目标
- ✅ 更新体重并重新计算RER和BMR
- ✅ 更新卡路里目标

#### updateActivityGoalDisplay函数
- ✅ 更新卡路里目标显示: `displayCalorieGoal`

## 🧪 测试步骤

### 1. 清除缓存并刷新
```
Cmd+Shift+R (Mac) 或 Ctrl+Shift+R (Windows)
```

### 2. 打开浏览器控制台
按 F12 或 Cmd+Option+I

### 3. 连接蓝牙并启动监测
1. 点击"连接蓝牙"
2. 点击"开始活动监测"

### 4. 验证图表初始化
控制台应该显示：
```
🎨 初始化活动监测图表...
✅ 找到步数环形图canvas
✅ 步数环形图初始化成功
✅ 找到活动量环形图canvas
✅ 活动量环形图初始化成功
✅ 找到卡路里环形图canvas
✅ 卡路里环形图初始化成功
✅ 找到每小时步数图canvas
✅ 每小时步数图初始化成功
✅ 找到每小时活动量图canvas
✅ 每小时活动量图初始化成功
✅ 找到每小时卡路里图canvas
✅ 每小时卡路里图初始化成功
✅ 找到活动强度趋势图canvas
✅ 活动强度趋势图初始化成功
🎨 图表初始化完成，已创建图表数量: 7
```

### 5. 验证数据更新
控制台应该显示（每5秒一次）：
```
📊 [5秒] ENMO=0.0678, MAD=0.0876, 强度=light, METs=2.0, 卡路里=0.0046, 新步数=0, 总步数=0
📊 [10秒] ENMO=0.1356, MAD=0.2489, 强度=moderate, METs=2.0, 卡路里=0.0091, 新步数=2, 总步数=2
```

### 6. 验证页面显示

#### 卡路里环形图
- 位置: 活动量环形图右侧
- 颜色: 橙色 (#FF9500)
- 显示内容:
  - 中间百分比: 0% → 逐渐增加
  - 总卡路里: 0.00 → 逐渐增加
  - 目标: 100 kcal
  - METs: 1.0 → 根据活动变化

#### 每小时卡路里分布图
- 位置: 每小时活动量分布图右侧
- 标题: 🔥 每小时卡路里分布
- Y轴: 卡路里 (kcal)
- X轴: 时间 (0:00 - 23:00)
- 柱状图颜色: 根据活动强度变化

#### 信息卡片
- 宠物体重: 10.0 kg
- 基础代谢(RER): 394 kcal/day (10kg宠物)
- 当前活动强度: 静息/轻度/中度/剧烈
- 最后更新: 实时时间

## 📊 预期数值 (10kg宠物)

### 静息1分钟
- 卡路里: ~0.27 kcal
- METs: 1.0
- 环形图: ~0.3%

### 慢走1分钟
- 卡路里: ~0.55 kcal
- METs: 2.0
- 环形图: ~0.6%

### 快走1分钟
- 卡路里: ~1.09 kcal
- METs: 4.0
- 环形图: ~1.1%

### 剧烈运动1分钟
- 卡路里: ~1.64 kcal
- METs: 6.0
- 环形图: ~1.6%

### 达到100 kcal目标
- 静息: ~370分钟 (6小时)
- 慢走: ~182分钟 (3小时)
- 快走: ~92分钟 (1.5小时)
- 剧烈运动: ~61分钟 (1小时)

## 🔍 调试命令

### 查看当前卡路里数据
```javascript
const summary = app.activityMonitor.getSummary();
console.log('总卡路里:', summary.totalCalories.toFixed(2));
console.log('卡路里百分比:', summary.calorieGoalPercent + '%');
console.log('当前METs:', summary.currentMETs);
console.log('体重:', summary.petWeight + 'kg');
console.log('RER:', summary.rerDaily.toFixed(0) + ' kcal/day');
```

### 查看每小时卡路里分布
```javascript
app.activityMonitor.hourlyData.forEach((h, i) => {
    if (h.calories > 0) {
        console.log(`${i}:00 - 卡路里: ${h.calories.toFixed(2)} kcal, 强度: ${h.intensity}`);
    }
});
```

### 手动更新图表
```javascript
app.activityMonitor.updateCharts();
console.log('图表已手动更新');
```

## ⚠️ 常见问题

### 问题1: 卡路里环形图不显示
**检查**:
```javascript
console.log('卡路里环形图:', app.activityMonitor.charts.calorieRing);
```
**解决**: 确保canvas元素ID为 `activityCalorieRingChart`

### 问题2: 每小时卡路里图不显示
**检查**:
```javascript
console.log('每小时卡路里图:', app.activityMonitor.charts.hourlyCalorie);
```
**解决**: 确保canvas元素ID为 `activityHourlyCalorieChart`

### 问题3: 卡路里数值不更新
**检查**:
```javascript
console.log('总卡路里:', app.activityMonitor.totalCalories);
console.log('BMR/秒:', app.activityMonitor.bmrPerSec);
console.log('当前METs:', app.activityMonitor.currentMETs);
```
**解决**: 确保calculateActivityMetrics返回了calories字段

### 问题4: METs显示为NaN
**检查**:
```javascript
console.log('ENMO值:', app.activityMonitor.activityHistory.slice(-1)[0]?.enmo);
```
**解决**: 确保ENMO计算正确

## ✅ 验证清单

- [ ] 卡路里环形图显示并更新
- [ ] 每小时卡路里分布图显示并更新
- [ ] 总卡路里数值实时更新
- [ ] 卡路里百分比正确计算
- [ ] METs值根据活动强度变化
- [ ] 体重显示正确
- [ ] RER显示正确
- [ ] 控制台输出包含卡路里和METs信息
- [ ] 重置数据时卡路里归零
- [ ] 更新目标时卡路里目标更新

---

**更新时间**: 2026-01-27
**状态**: 卡路里功能已完整集成到页面
