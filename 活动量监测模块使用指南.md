# 活动量与步数监测模块 - 使用指南

## 📋 模块概述

本模块基于IMU加速度计数据，实现了类似Apple Health的活动量和步数可视化功能。

### 核心功能
1. **实时活动量计算** - 使用ENMO (Euclidean Norm Minus One) 算法
2. **步数统计** - 基于峰值检测的步数计数算法
3. **活动强度分级** - 静息/轻度/中度/剧烈四个等级
4. **Apple Health风格可视化** - 环形进度图和柱状图
5. **每小时趋势分析** - 24小时活动分布

## 🚀 快速开始

### 1. 启动Web服务器

**macOS/Linux:**
```bash
cd web
python3 -m http.server 8000
```

**Windows:**
```cmd
cd web
启动服务器.bat
```

### 2. 访问活动监测页面

在浏览器中打开:
```
http://localhost:8000/activity-health.html
```

### 3. 连接蓝牙设备

1. 点击"连接蓝牙设备"按钮
2. 选择你的IMU设备 (Nordic UART Service)
3. 等待连接成功提示
4. 系统将自动开始接收和处理加速度数据

## 📊 界面说明

### 活动环 (Activity Rings)
- **步数环** (绿色) - 显示当前步数占每日目标的百分比
- **活动量环** (红色) - 显示当前活动量占每日目标的百分比

### 图表区域
1. **每小时步数分布** - 柱状图显示24小时内每小时的步数
2. **每小时活动量分布** - 柱状图显示24小时内每小时的活动量
3. **实时活动强度趋势** - 折线图显示最近10分钟的活动强度变化

### 颜色编码
- 🔴 **红色** - 剧烈活动 (MAD > 0.15g)
- 🟠 **橙色** - 中度活动 (MAD > 0.08g)
- 🟢 **绿色** - 轻度活动 (MAD > 0.02g)
- ⚪ **灰色** - 静息状态

## 🔧 配置选项

### 设置每日目标
- **每日步数目标**: 默认1000步，可根据宠物活动量调整
- **每日活动量目标**: 默认100 ENMO，可根据需要调整

### 重置数据
点击"重置今日数据"按钮可清空当天的累计数据，适用于:
- 新的一天开始时
- 测试新设备时
- 需要重新统计时

## 📡 数据格式

模块自动解析蓝牙设备发送的数据，支持以下格式:

```
ADC:8118 12161|Acc:-0.153 0.027 0.943|Gyr:-6.2 0.5 -0.4|T:23.6
```

其中:
- `Acc:x y z` - 加速度数据 (单位: g)
- 采样率: 50Hz (可在代码中调整)

## 🧮 算法说明

### ENMO (活动量指标)
```
ENMO = Σ max(0, SVM - 1g)
```
- SVM = √(ax² + ay² + az²)
- 去除重力分量，只保留运动产生的加速度
- 累计值越大表示运动量越大

### MAD (活动强度指标)
```
MAD = mean(|SVM - mean(SVM)|)
```
- 描述加速度偏离平均值的程度
- 对传感器校准误差不敏感
- 用于实时判断活动强度等级

### 步数检测
1. 计算合加速度 (SVM)
2. 带通滤波 (0.5Hz - 5Hz) 提取步态信号
3. 峰值检测 (最小峰高0.05g，最小步间距0.25秒)
4. 统计峰值数量作为步数

## 🔗 与现有系统集成

### 方式1: 独立使用
直接访问 `activity-health.html` 页面，独立运行活动监测功能。

### 方式2: 集成到主页面
在 `index.html` 中添加链接:
```html
<a href="activity-health.html" target="_blank">活动量监测</a>
```

### 方式3: 嵌入式集成
在主应用中引入模块:
```html
<script src="activity-monitor.js"></script>
<script>
  const activityMonitor = new ActivityMonitor(50);
  activityMonitor.initializeCharts();

  // 在接收到加速度数据时调用
  activityMonitor.addAccelerometerData(ax, ay, az, timestamp);
</script>
```

## 📁 文件说明

- `activity-monitor.js` - 核心算法模块 (活动量计算、步数检测、图表管理)
- `activity-health.html` - 用户界面 (Apple Health风格)
- `style.css` - 样式文件 (复用现有样式)
- `bluetooth.js` - 蓝牙通信模块 (复用现有模块)

## 🎯 使用场景

1. **宠物日常活动监测** - 了解宠物每天的活动量和步数
2. **健康评估** - 通过活动强度判断宠物健康状态
3. **运动量对比** - 对比不同时间段的活动水平
4. **康复监测** - 监测术后宠物的活动恢复情况

## ⚠️ 注意事项

1. **采样率要求**: 建议使用50Hz采样率以保证步数检测准确性
2. **设备佩戴**: 确保IMU设备稳固佩戴在宠物身上
3. **校准**: 首次使用时建议让宠物静止几秒钟以校准基线
4. **浏览器兼容**: 需要支持Web Bluetooth API的浏览器 (Chrome/Edge)

## 🔍 故障排查

### 问题: 无法连接蓝牙
- 确认浏览器支持Web Bluetooth API
- 检查蓝牙设备是否开启
- 确认设备UUID正确 (Nordic UART Service)

### 问题: 步数不准确
- 检查采样率设置是否为50Hz
- 调整峰值检测阈值 (在activity-monitor.js中)
- 确认设备佩戴位置稳定

### 问题: 图表不更新
- 检查浏览器控制台是否有错误
- 确认Chart.js库已正确加载
- 刷新页面重新初始化

## 📞 技术支持

如有问题，请检查:
1. 浏览器控制台日志
2. 系统日志区域的错误信息
3. 蓝牙连接状态

---

**版本**: 1.0.0
**更新日期**: 2026-01-27
**作者**: 资深嵌入式IMU工程师团队
