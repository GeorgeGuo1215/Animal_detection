# 活动量监测模块修复说明

## 修复内容

### 1. 静息范围调整 ✅

**问题**: 原来的活动强度阈值太低，导致心跳和呼吸产生的微小IMU变动被识别为活动。

**解决方案**: 提高活动强度阈值

```javascript
// 修改前
if (mad > 0.15) intensity = 'vigorous';      // 剧烈运动
else if (mad > 0.08) intensity = 'moderate'; // 中度运动
else if (mad > 0.02) intensity = 'light';    // 轻度运动

// 修改后
if (mad > 0.20) intensity = 'vigorous';      // 剧烈运动 (提高阈值)
else if (mad > 0.12) intensity = 'moderate'; // 中度运动 (提高阈值)
else if (mad > 0.05) intensity = 'light';    // 轻度运动 (提高阈值，避免心跳呼吸干扰)
```

**说明**:
- 心跳和呼吸通常产生 < 0.05g 的加速度变化
- 新阈值 0.05g 可以有效过滤心跳呼吸的影响
- 只有真正的身体运动才会被识别为活动

### 2. 图表显示修复 ✅

**问题**: 每小时步数分布、每小时活动量分布、实时活动强度趋势图无任何显示。

**解决方案**:

#### 2.1 添加图表初始化调试
- 添加详细的console.log输出，追踪图表初始化过程
- 添加错误捕获，防止单个图表初始化失败影响其他图表
- 验证canvas元素是否存在

#### 2.2 优化趋势图数据采样
```javascript
// 修改前: 显示所有数据点（可能太多）
const recentData = this.activityHistory.slice(-600);

// 修改后: 每5秒采样一次，减少数据点
const tenMinutesAgo = Date.now() - 10 * 60 * 1000;
const recentData = this.activityHistory.filter(item => item.timestamp >= tenMinutesAgo);
const sampledData = [];
for (let i = 0; i < recentData.length; i += 5) {
    sampledData.push(recentData[i]);
}
```

#### 2.3 添加数据处理调试
- 在processActivityMetrics()中添加调试日志
- 显示ENMO、MAD、强度、步数等关键指标
- 追踪数据流向

### 3. 数据验证 ✅

添加了多个检查点：
- 图表初始化时检查canvas元素是否存在
- 图表更新前检查图表对象是否已创建
- 数据为空时跳过更新并输出警告

## 测试步骤

### 1. 打开Web界面
```
http://localhost:8000/index.html
```

### 2. 连接蓝牙设备
1. 点击"连接蓝牙"按钮
2. 选择IMU设备
3. 等待连接成功

### 3. 启动活动监测
1. 连接成功后，"开始活动监测"按钮会显示
2. 点击"开始活动监测"
3. 活动监测仪表板会展开显示

### 4. 查看浏览器控制台
打开浏览器开发者工具 (F12)，查看Console标签：

**预期输出**:
```
🎨 初始化活动监测图表...
✅ 找到步数环形图canvas
✅ 步数环形图初始化成功
✅ 找到活动量环形图canvas
✅ 活动量环形图初始化成功
✅ 找到每小时步数图canvas
✅ 每小时步数图初始化成功
✅ 找到每小时活动量图canvas
✅ 每小时活动量图初始化成功
✅ 找到活动强度趋势图canvas
✅ 活动强度趋势图初始化成功
🎨 图表初始化完成，已创建图表数量: 5
```

### 5. 观察数据更新
当接收到加速度数据时，控制台会显示：
```
📊 活动指标: ENMO=0.0234, MAD=0.0123, 强度=resting, 步数=0
```

如果检测到步数：
```
👣 检测到步数: +2, 总计: 2
```

### 6. 验证图表显示
- **环形图**: 应该显示步数和活动量的完成百分比
- **每小时柱状图**: 应该显示当前小时的数据（初始可能为0）
- **趋势图**: 收集10秒以上数据后开始显示曲线

## 常见问题排查

### 问题1: 图表仍然不显示
**检查**:
1. 浏览器控制台是否有错误
2. Chart.js库是否正确加载
3. canvas元素是否存在

**解决**:
```javascript
// 在控制台执行
console.log('Chart.js:', typeof Chart);
console.log('Canvas元素:', document.getElementById('activityStepsRingChart'));
```

### 问题2: 静息状态仍然显示为活动
**检查**:
1. 查看控制台输出的MAD值
2. 如果MAD < 0.05 但仍显示活动，说明阈值需要进一步调整

**调整**:
在 `activity-monitor.js` 中修改阈值：
```javascript
else if (mad > 0.08) intensity = 'light';  // 进一步提高阈值
```

### 问题3: 步数检测不准确
**原因**:
- 采样率不是50Hz
- 设备佩戴不稳定
- 峰值检测阈值不合适

**调整**:
在 `activity-monitor.js` 的 `countSteps()` 方法中：
```javascript
const minPeakHeight = 0.08;  // 提高峰值高度阈值
const minPeakDistance = Math.floor(this.fs / 3);  // 调整最小步间距
```

## 技术细节

### MAD (Mean Amplitude Deviation) 阈值说明

| MAD值 (g) | 活动类型 | 示例 |
|-----------|---------|------|
| < 0.05 | 静息 | 躺着、坐着、心跳呼吸 |
| 0.05 - 0.12 | 轻度活动 | 慢走、站立移动 |
| 0.12 - 0.20 | 中度活动 | 快走、慢跑 |
| > 0.20 | 剧烈活动 | 跑步、跳跃 |

### 心跳和呼吸的IMU特征

**心跳**:
- 频率: 60-120 bpm (1-2 Hz)
- 加速度幅度: 0.01-0.03g
- 特征: 规律的周期性振动

**呼吸**:
- 频率: 12-20 bpm (0.2-0.33 Hz)
- 加速度幅度: 0.02-0.05g
- 特征: 缓慢的周期性变化

**过滤策略**:
- 使用MAD阈值 > 0.05g 过滤心跳呼吸
- 步数检测使用带通滤波器 (0.5-5 Hz) 进一步过滤

## 更新日志

**2026-01-27**:
- ✅ 提高活动强度阈值，避免心跳呼吸干扰
- ✅ 添加图表初始化调试和错误处理
- ✅ 优化趋势图数据采样
- ✅ 添加数据处理调试日志
- ✅ 修复图表更新逻辑

---

**版本**: 1.1.0
**状态**: 已修复
