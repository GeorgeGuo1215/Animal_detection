# 🔄 清除浏览器缓存指南

## ⚠️ 核心问题

浏览器缓存了**旧版本的 app.js**，导致新添加的函数导出代码没有生效。

## ✅ 解决方案

### 方法1: 强制刷新（推荐，最快）

1. **完全关闭浏览器**（所有标签页）
2. **重新打开浏览器**
3. **访问页面**：`http://localhost:8000/index.html`
4. **强制刷新**：
   - **Windows**: 按住 `Ctrl + Shift + R`
   - **Mac**: 按住 `Cmd + Shift + R`
   - 或者按 `F12` 打开开发者工具，右键刷新按钮，选择"清空缓存并硬性重新加载"

### 方法2: 使用测试页面（验证修复）

访问专门的测试页面，它会自动检查函数是否正确导出：

```
http://localhost:8000/test-functions.html
```

**这个页面会显示**：
- ✅ 所有脚本是否加载
- ✅ 所有函数是否导出
- ✅ 可以直接测试按钮功能

### 方法3: 开发者工具清除缓存

1. 按 `F12` 打开开发者工具
2. 切换到 **Application** 标签（Chrome/Edge）或 **Storage** 标签（Firefox）
3. 点击左侧 **"Clear storage"** 或 **"清除存储数据"**
4. 勾选 **"Cached images and files"**
5. 点击 **"Clear site data"** 或 **"清除数据"**
6. 刷新页面（F5）

### 方法4: 隐私模式测试

1. 打开浏览器的**隐私/无痕模式**：
   - Chrome/Edge: `Ctrl + Shift + N`
   - Firefox: `Ctrl + Shift + P`
   - Safari: `Cmd + Shift + N`
2. 在隐私模式下访问：`http://localhost:8000/index.html`
3. 这样可以避免缓存干扰

## 🔍 验证修复是否成功

### 步骤1: 打开控制台（F12）

应该看到这些日志（按顺序）：

```
✅ SleepMonitor类已导出到全局作用域
✅ 睡眠监测函数已导出到全局作用域
验证: startSleepMonitor = function
验证: stopSleepMonitor = function
验证: resetSleepData = function
```

### 步骤2: 手动测试

在控制台输入以下命令：

```javascript
// 测试1: 检查函数类型
console.log('startSleepMonitor:', typeof startSleepMonitor);
// 应该输出: startSleepMonitor: function

// 测试2: 检查window对象
console.log('window.startSleepMonitor:', typeof window.startSleepMonitor);
// 应该输出: window.startSleepMonitor: function

// 测试3: 列出所有睡眠相关函数
console.log({
    startSleepMonitor: typeof window.startSleepMonitor,
    stopSleepMonitor: typeof window.stopSleepMonitor,
    resetSleepData: typeof window.resetSleepData,
    generateSleepReport: typeof window.generateSleepReport,
    updateSleepDisplay: typeof window.updateSleepDisplay,
    sleepLog: typeof window.sleepLog
});
// 所有值都应该是 "function"
```

### 步骤3: 点击按钮测试

点击 **"😴 开始睡眠监测"** 按钮，应该看到：

**控制台输出**：
```
😴 开始睡眠监测...
📊 蓝牙连接状态: false
📊 活动监测状态: false
📊 创建SleepMonitor实例...
```

**页面变化**：
- "开始睡眠监测" 按钮隐藏
- "停止监测" 按钮显示

## ❌ 如果还是不行

### 检查清单

1. **确认服务器正在运行**：
   ```bash
   cd web
   python -m http.server 8000
   ```

2. **确认访问的是正确的URL**：
   ```
   http://localhost:8000/index.html
   ```
   ⚠️ 不要使用 `file://` 协议打开文件

3. **检查app.js是否加载**：
   - 打开 `F12` → `Network` 标签
   - 刷新页面
   - 找到 `app.js?v=20260122-sleep`
   - 确认状态是 `200 OK`
   - 确认大小不是 0
   - 点击查看内容，搜索 `window.startSleepMonitor`，应该能找到

4. **检查是否有JavaScript错误**：
   - 打开 `F12` → `Console` 标签
   - 查看是否有红色错误信息
   - 如果有错误，记录下来

5. **使用测试页面诊断**：
   ```
   http://localhost:8000/test-functions.html
   ```
   这个页面会明确告诉你哪里出了问题

## 🔧 我修改了什么

### 修改1: app.js（添加函数导出）

在文件末尾添加：
```javascript
// 导出睡眠监测相关函数到全局作用域
if (typeof window !== 'undefined') {
    window.startSleepMonitor = startSleepMonitor;
    window.stopSleepMonitor = stopSleepMonitor;
    window.resetSleepData = resetSleepData;
    window.generateSleepReport = generateSleepReport;
    window.updateSleepDisplay = updateSleepDisplay;
    window.sleepLog = sleepLog;
    
    console.log('✅ 睡眠监测函数已导出到全局作用域');
    console.log('验证: startSleepMonitor =', typeof window.startSleepMonitor);
    console.log('验证: stopSleepMonitor =', typeof window.stopSleepMonitor);
    console.log('验证: resetSleepData =', typeof window.resetSleepData);
}
```

### 修改2: index.html（更新版本号）

```html
<!-- 旧版本 -->
<script src="app.js?v=20260113-16"></script>

<!-- 新版本 -->
<script src="app.js?v=20260122-sleep"></script>
```

这个版本号的改变会**强制浏览器下载新文件**，不使用缓存。

## 📱 移动设备清除缓存

### iOS Safari
1. 设置 → Safari
2. 清除历史记录与网站数据
3. 或者在页面长按刷新按钮

### Android Chrome
1. 设置 → 隐私和安全 → 清除浏览数据
2. 选择"缓存的图片和文件"
3. 点击"清除数据"

---

**如果以上方法都不行，请提供：**
1. 控制台的完整错误信息
2. Network标签中app.js的加载状态截图
3. `http://localhost:8000/test-functions.html` 的测试结果