# 睡眠监测功能集成说明

## 📋 功能概述

基于IMU加速度计数据，实现宠物睡眠质量监测功能，包括睡眠阶段分类、睡眠事件检测和睡眠质量评估。

## 🔧 核心算法

### 1. 零交叉率 (MCR - Mean Crossing Rate)

检测信号穿越均值的频率，用于判断体动频率。

```javascript
MCR = 零交叉次数 / 时间窗口长度
```

**应用**：
- 高MCR (>5次/秒): 清醒状态，频繁活动
- 中MCR (2-5次/秒): 浅睡或REM睡眠
- 低MCR (<2次/秒): 深睡状态

### 2. RMS能量计算

计算加速度计三轴的均方根能量，反映运动强度。

```javascript
RMS = sqrt(mean(ax² + ay² + az²))
```

**应用**：
- 高RMS (>0.05g): 清醒或活动
- 中RMS (0.02-0.05g): 浅睡或REM
- 低RMS (<0.02g): 深睡状态

### 3. 睡眠阶段分类

基于RMS和MCR的组合判断睡眠阶段：

| 阶段 | RMS范围 | MCR范围 | 特征 |
|------|---------|---------|------|
| 清醒 (Awake) | >0.05g | >5次/秒 | 频繁活动 |
| 浅睡 (Light) | <0.03g | 2-5次/秒 | 轻微体动 |
| 深睡 (Deep) | <0.02g | <2次/秒 | 几乎无体动 |
| REM睡眠 | 0.02-0.05g | 3-8次/秒 | 快速眼动期 |

## 📝 代码结构

### 1. sleep-monitor.js (702行)

核心睡眠监测模块，包含：

#### 构造函数
```javascript
constructor(samplingRate = 50, petWeight = 10.0)
```
- 采样率: 50Hz (与IMU数据一致)
- 窗口大小: 300样本 (6秒)
- 滑动步长: 50样本 (1秒)

#### 核心方法
- `calculateMCR(signal)`: 计算零交叉率
- `calculateRMS(ax, ay, az)`: 计算RMS能量
- `classifySleepStage(rms, mcr)`: 分类睡眠阶段
- `addAccelerometerData(ax, ay, az, timestamp)`: 添加数据
- `processAccelerometerData()`: 处理数据窗口

#### 事件检测
- `detectSleepEvents()`: 检测睡眠事件
  - 入睡事件 (sleep_onset)
  - 醒来事件 (wake_up)
  - 翻身事件 (turn_over)
  - 上床/离床事件 (in_bed/out_of_bed)

#### 可视化
- `initializeCharts()`: 初始化图表
  - 睡眠阶段时间线 (阶梯图)
  - RMS能量趋势 (折线图)
  - 睡眠周期分布 (饼图)
- `updateCharts()`: 更新图表数据

#### 报告生成
- `generateSleepReport()`: 生成详细睡眠报告
  - 睡眠质量评分 (0-100分)
  - 睡眠阶段统计
  - 睡眠效率计算
  - 个性化建议

### 2. index.html 更新

添加睡眠监测UI部分 (约100行)：

- 控制按钮区域
- 实时状态卡片 (当前阶段、时长、效率、翻身次数)
- 睡眠周期饼图
- 睡眠阶段时间线图
- RMS能量趋势图
- 睡眠统计信息
- 睡眠事件日志

### 3. app.js 更新

添加睡眠监测集成代码 (约200行)：

#### 初始化
```javascript
this.sleepMonitor = null;
this.sleepMonitorEnabled = false;
```

#### 数据流
```javascript
// 在handleBLEData中添加
if (this.sleepMonitorEnabled && this.sleepMonitor) {
    this.sleepMonitor.addAccelerometerData(accX, accY, accZ, Date.now());
}
```

#### 控制函数
- `startSleepMonitor()`: 启动睡眠监测
- `stopSleepMonitor()`: 停止睡眠监测
- `resetSleepData()`: 重置睡眠数据
- `generateSleepReport()`: 生成睡眠报告
- `updateSleepDisplay()`: 更新显示
- `sleepLog()`: 日志输出

## 🎯 使用流程

### 1. 连接设备
1. 点击"连接蓝牙"按钮
2. 选择蓝牙设备并连接
3. 等待IMU数据开始接收

### 2. 启动监测
1. 连接成功后，"开始睡眠监测"按钮会显示
2. 点击"开始睡眠监测"
3. 系统开始实时分析睡眠状态

### 3. 实时监控
- 查看当前睡眠阶段
- 观察睡眠时长
- 监控睡眠效率
- 查看翻身次数
- 观察图表变化

### 4. 生成报告
1. 点击"生成报告"按钮
2. 查看详细的睡眠质量分析
3. 获取个性化建议
4. 可打印或保存报告

## 📊 睡眠质量评分算法

总分100分，由以下部分组成：

### 1. 深睡比例 (30分)
- 理想范围: 20-25%
- 评分公式: `30 - |实际比例 - 22.5| × 2`

### 2. 睡眠效率 (30分)
- 理想值: ≥85%
- 评分公式: `(实际效率 / 85) × 30`

### 3. 翻身频率 (20分)
- 理想值: <3次/小时
- 评分公式: `20 - (实际频率 - 3) × 5`

### 4. REM睡眠比例 (20分)
- 理想范围: 20-25%
- 评分公式: `20 - |实际比例 - 22.5| × 2`

### 质量等级
- 优秀: ≥80分
- 良好: 60-79分
- 一般: 40-59分
- 差: <40分

## 🔍 阈值配置

可根据不同宠物调整的阈值参数：

```javascript
this.thresholds = {
    inBedRMS: 0.05,        // 在床判定阈值 (g)
    deepSleepRMS: 0.02,    // 深睡阈值 (g)
    lightSleepRMS: 0.03,   // 浅睡阈值 (g)
    awakeMCR: 5,           // 清醒MCR阈值 (次/秒)
    deepSleepMCR: 2,       // 深睡MCR阈值 (次/秒)
    minSleepDuration: 600, // 最小睡眠时长 (秒)
    minStageDuration: 60,  // 最小阶段持续时长 (秒)
    remRMSMin: 0.02,       // REM最小RMS (g)
    remRMSMax: 0.05,       // REM最大RMS (g)
    remMCRMin: 3,          // REM最小MCR (次/秒)
    remMCRMax: 8,          // REM最大MCR (次/秒)
    turnOverRMS: 0.15      // 翻身阈值 (g)
};
```

## 🧪 测试建议

### 1. 静息测试
- 让宠物保持静止
- 预期: RMS < 0.02g, MCR < 2, 阶段=深睡

### 2. 轻微活动测试
- 宠物轻微移动
- 预期: RMS 0.02-0.05g, MCR 2-5, 阶段=浅睡或REM

### 3. 活动测试
- 宠物正常活动
- 预期: RMS > 0.05g, MCR > 5, 阶段=清醒

### 4. 长时间监测
- 监测完整睡眠周期 (2-4小时)
- 验证阶段转换是否合理
- 检查睡眠效率计算

## ⚠️ 注意事项

1. **采样率一致性**: 确保IMU采样率为50Hz
2. **窗口大小**: 6秒窗口可能需要根据实际情况调整
3. **阈值校准**: 不同品种/体型的宠物可能需要不同阈值
4. **环境因素**: 床垫硬度、环境噪音可能影响检测
5. **数据质量**: 确保IMU数据稳定可靠

## 🚀 未来优化方向

1. **自适应阈值**: 根据宠物历史数据自动调整阈值
2. **呼吸检测**: 结合雷达数据检测呼吸频率
3. **睡眠周期识别**: 识别完整的睡眠周期
4. **异常检测**: 检测睡眠异常（如失眠、频繁醒来）
5. **长期趋势**: 分析睡眠质量的长期变化趋势
6. **多宠物支持**: 支持多只宠物的睡眠监测
7. **云端同步**: 将睡眠数据同步到云端

## 📚 参考文献

1. 原始睡眠检测算法: `/睡眠算法/sleepproj_py/onbeddetection_v2.py`
2. 运动计算算法: `/睡眠算法/sleepproj_py/Calculate_motion.py`
3. 活动监测模块: `web/activity-monitor.js`

---

**版本**: 1.0.0
**更新时间**: 2026-01-28
**状态**: 睡眠监测功能已完整集成
