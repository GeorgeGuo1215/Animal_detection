# 睡眠监测数据流诊断指南

## 🐛 问题症状

用户报告：
- RMS能量显示 0.000g
- 数据更新显示 0 Hz
- 显示"等待数据"
- 蓝牙已连接，频率50Hz

## 🔍 诊断步骤

### 1. 检查蓝牙连接状态

在浏览器控制台执行：
```javascript
console.log('蓝牙连接:', app.bleConnected);
console.log('采样率:', app.processor.fs);
```

**预期输出**：
```
蓝牙连接: true
采样率: 50
```

### 2. 检查睡眠监测启用状态

```javascript
console.log('睡眠监测启用:', app.sleepMonitorEnabled);
console.log('睡眠监测实例:', app.sleepMonitor);
```

**预期输出**：
```
睡眠监测启用: true
睡眠监测实例: SleepMonitor {fs: 50, ...}
```

### 3. 检查加速度计数据

```javascript
console.log('加速度缓冲区长度:', app.sleepMonitor.axBuffer.length);
console.log('最近的加速度数据:', {
    ax: app.sleepMonitor.axBuffer.slice(-5),
    ay: app.sleepMonitor.ayBuffer.slice(-5),
    az: app.sleepMonitor.azBuffer.slice(-5)
});
```

**预期输出**：
```
加速度缓冲区长度: 250  (或其他非0值)
最近的加速度数据: {
    ax: [0.012, 0.015, 0.013, 0.014, 0.016],
    ay: [-0.008, -0.009, -0.007, -0.008, -0.009],
    az: [0.998, 0.997, 0.999, 0.998, 0.997]
}
```

### 4. 检查数据更新计数

```javascript
console.log('数据更新次数:', app.sleepMonitor.dataUpdateCount);
console.log('睡眠历史记录数:', app.sleepMonitor.sleepHistory.length);
```

**预期输出**：
```
数据更新次数: 15  (或其他非0值)
睡眠历史记录数: 15
```

### 5. 检查实时指标

```javascript
const summary = app.sleepMonitor.getSummary();
console.log('当前RMS:', summary.currentRMS);
console.log('当前MCR:', summary.currentMCR);
console.log('数据更新率:', summary.dataRate);
```

**预期输出**：
```
当前RMS: 0.0145
当前MCR: 1.2
数据更新率: 1.0
```

## 🔧 常见问题及解决方案

### 问题1: 睡眠监测未启用

**症状**：
```
睡眠监测启用: false
```

**解决**：
1. 确保点击了"开始睡眠监测"按钮
2. 检查按钮是否可见（需要先连接蓝牙）
3. 刷新页面后重新连接蓝牙并启动

### 问题2: 加速度缓冲区为空

**症状**：
```
加速度缓冲区长度: 0
```

**原因**：
- 蓝牙数据流中没有加速度计数据
- 数据格式不正确
- 数据未被正确解析

**解决**：
```javascript
// 检查handleBLEData是否被调用
console.log('检查数据流...');

// 临时添加日志到handleBLEData
// 在app.js的handleBLEData方法中查看accX, accY, accZ的值
```

### 问题3: 数据未达到窗口大小

**症状**：
```
加速度缓冲区长度: 150  (< 300)
数据更新次数: 0
```

**原因**：
- 窗口大小为300样本（6秒@50Hz）
- 数据还未积累到足够处理

**解决**：
- 等待至少6秒让缓冲区填满
- 第一次处理需要300个样本

### 问题4: 图表未初始化

**症状**：
```
app.sleepMonitor.charts.rmsChart: null
```

**解决**：
```javascript
// 手动初始化图表
app.sleepMonitor.initializeCharts();
```

## 📊 完整诊断脚本

将以下代码复制到浏览器控制台执行：

```javascript
console.log('=== 睡眠监测诊断 ===');
console.log('');

// 1. 基础状态
console.log('1. 基础状态:');
console.log('  蓝牙连接:', app.bleConnected);
console.log('  采样率:', app.processor.fs, 'Hz');
console.log('  睡眠监测启用:', app.sleepMonitorEnabled);
console.log('  睡眠监测实例:', app.sleepMonitor ? '已创建' : '未创建');
console.log('');

if (!app.sleepMonitor) {
    console.error('❌ 睡眠监测实例未创建！请点击"开始睡眠监测"按钮');
} else {
    // 2. 数据缓冲区
    console.log('2. 数据缓冲区:');
    console.log('  加速度缓冲区长度:', app.sleepMonitor.axBuffer.length);
    console.log('  窗口大小:', app.sleepMonitor.windowSize);
    console.log('  需要样本数:', app.sleepMonitor.windowSize - app.sleepMonitor.axBuffer.length);
    console.log('');

    // 3. 数据更新
    console.log('3. 数据更新:');
    console.log('  数据更新次数:', app.sleepMonitor.dataUpdateCount);
    console.log('  睡眠历史记录数:', app.sleepMonitor.sleepHistory.length);
    console.log('');

    // 4. 实时指标
    if (app.sleepMonitor.dataUpdateCount > 0) {
        const summary = app.sleepMonitor.getSummary();
        console.log('4. 实时指标:');
        console.log('  当前RMS:', summary.currentRMS.toFixed(4), 'g');
        console.log('  当前MCR:', summary.currentMCR.toFixed(2), '次/秒');
        console.log('  数据更新率:', summary.dataRate.toFixed(2), 'Hz');
        console.log('  当前阶段:', summary.currentStageName);
        console.log('');
    } else {
        console.log('4. 实时指标: 等待数据处理...');
        console.log('');
    }

    // 5. 图表状态
    console.log('5. 图表状态:');
    console.log('  RMS图表:', app.sleepMonitor.charts.rmsChart ? '已初始化' : '未初始化');
    console.log('  阶段时间线图:', app.sleepMonitor.charts.sleepStageTimeline ? '已初始化' : '未初始化');
    console.log('  睡眠周期图:', app.sleepMonitor.charts.sleepCycleChart ? '已初始化' : '未初始化');
    console.log('');

    // 6. 最近的数据
    if (app.sleepMonitor.axBuffer.length > 0) {
        console.log('6. 最近的加速度数据:');
        const recent = Math.min(5, app.sleepMonitor.axBuffer.length);
        console.log('  ax:', app.sleepMonitor.axBuffer.slice(-recent).map(v => v.toFixed(3)));
        console.log('  ay:', app.sleepMonitor.ayBuffer.slice(-recent).map(v => v.toFixed(3)));
        console.log('  az:', app.sleepMonitor.azBuffer.slice(-recent).map(v => v.toFixed(3)));
    } else {
        console.log('6. 加速度数据: 缓冲区为空');
    }
}

console.log('');
console.log('=== 诊断完成 ===');
```

## ✅ 正常状态示例

```
=== 睡眠监测诊断 ===

1. 基础状态:
  蓝牙连接: true
  采样率: 50 Hz
  睡眠监测启用: true
  睡眠监测实例: 已创建

2. 数据缓冲区:
  加速度缓冲区长度: 250
  窗口大小: 300
  需要样本数: 50

3. 数据更新:
  数据更新次数: 15
  睡眠历史记录数: 15

4. 实时指标:
  当前RMS: 0.0145 g
  当前MCR: 1.20 次/秒
  数据更新率: 1.00 Hz
  当前阶段: 深睡

5. 图表状态:
  RMS图表: 已初始化
  阶段时间线图: 已初始化
  睡眠周期图: 已初始化

6. 最近的加速度数据:
  ax: [0.012, 0.015, 0.013, 0.014, 0.016]
  ay: [-0.008, -0.009, -0.007, -0.008, -0.009]
  az: [0.998, 0.997, 0.999, 0.998, 0.997]

=== 诊断完成 ===
```

## 🚨 异常状态示例

```
=== 睡眠监测诊断 ===

1. 基础状态:
  蓝牙连接: true
  采样率: 50 Hz
  睡眠监测启用: true
  睡眠监测实例: 已创建

2. 数据缓冲区:
  加速度缓冲区长度: 0  ❌
  窗口大小: 300
  需要样本数: 300

3. 数据更新:
  数据更新次数: 0  ❌
  睡眠历史记录数: 0  ❌

4. 实时指标: 等待数据处理...

5. 图表状态:
  RMS图表: 已初始化
  阶段时间线图: 已初始化
  睡眠周期图: 已初始化

6. 加速度数据: 缓冲区为空  ❌

=== 诊断完成 ===

问题：加速度数据未流入睡眠监测模块
```

## 🔧 快速修复

### 修复1: 重启睡眠监测

```javascript
// 停止
app.sleepMonitorEnabled = false;

// 等待1秒
setTimeout(() => {
    // 重启
    startSleepMonitor();
}, 1000);
```

### 修复2: 手动喂数据（测试用）

```javascript
// 模拟静息状态数据
for (let i = 0; i < 300; i++) {
    app.sleepMonitor.addAccelerometerData(
        0.01 + Math.random() * 0.005,  // ax
        -0.008 + Math.random() * 0.003, // ay
        0.998 + Math.random() * 0.002,  // az
        Date.now()
    );
}
console.log('✅ 已手动添加300个测试数据点');
```

### 修复3: 检查数据流

```javascript
// 在handleBLEData中临时添加日志
// 找到app.js中的handleBLEData方法，在睡眠监测数据喂入处添加：
console.log('喂入睡眠监测:', {accX, accY, accZ, enabled: app.sleepMonitorEnabled});
```

---

**版本**: 1.0.0
**创建时间**: 2026-01-28
**用途**: 诊断睡眠监测数据流问题
