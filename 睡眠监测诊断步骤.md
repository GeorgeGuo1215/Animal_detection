# 😴 睡眠监测按钮无反应 - 诊断步骤

## 🔍 问题诊断工具

我已经创建了一个专门的诊断页面来帮助你找出问题。

### 使用诊断工具

1. **启动本地服务器**（如果还没启动）：
   ```bash
   cd web
   python -m http.server 8000
   ```

2. **打开诊断页面**：
   ```
   http://localhost:8000/test-sleep-monitor.html
   ```

3. **按照页面上的6个步骤依次检查**：
   - ✅ 检查脚本加载
   - ✅ 检查SleepMonitor类
   - ✅ 检查全局函数
   - ✅ 测试创建实例
   - ✅ 测试按钮点击
   - ✅ 查看控制台日志

## 🐛 可能的问题原因

### 1. SleepMonitor类未导出
**症状**: 诊断页面显示 "❌ SleepMonitor: 未找到"

**解决方案**: 
检查 `sleep-monitor.js` 文件末尾是否有导出代码：
```javascript
// 文件末尾应该有：
if (typeof window !== 'undefined') {
    window.SleepMonitor = SleepMonitor;
    console.log('✅ SleepMonitor类已导出到全局作用域');
}
```

如果没有，需要添加这段代码。

### 2. 脚本加载顺序错误
**症状**: 控制台报错 "SleepMonitor is not defined"

**检查方法**: 
在 `index.html` 中确认脚本加载顺序：
```html
<!-- 正确的顺序 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="fft.js"></script>
<script src="bluetooth.js"></script>
<script src="radar-processor.js"></script>
<script src="sleep-monitor.js"></script>  <!-- 必须在app.js之前 -->
<script src="app.js"></script>
```

### 3. 浏览器缓存问题
**症状**: 修改代码后仍然无效

**解决方案**:
- 按 `Ctrl + Shift + R` (Windows) 或 `Cmd + Shift + R` (Mac) 强制刷新
- 或者在开发者工具中右键刷新按钮 → "清空缓存并硬性重新加载"

### 4. JavaScript错误
**症状**: 其他错误阻止了代码执行

**检查方法**:
1. 打开浏览器开发者工具（F12）
2. 切换到 Console 标签
3. 查看是否有红色错误信息
4. 找到第一个错误，通常其他错误都是连锁反应

### 5. app对象未初始化
**症状**: 控制台显示 "应用未初始化"

**检查方法**:
在控制台输入：
```javascript
console.log('app:', window.app);
console.log('app存在:', typeof app !== 'undefined');
```

如果返回 `undefined`，说明 `app.js` 有问题。

## 🔧 手动测试步骤

如果诊断页面无法访问，可以在主页面的控制台手动测试：

### 步骤1: 检查SleepMonitor类
```javascript
console.log('SleepMonitor:', typeof SleepMonitor);
// 应该输出: SleepMonitor: function
```

### 步骤2: 检查startSleepMonitor函数
```javascript
console.log('startSleepMonitor:', typeof startSleepMonitor);
// 应该输出: startSleepMonitor: function
```

### 步骤3: 检查app对象
```javascript
console.log('app:', window.app);
console.log('app.processor:', app?.processor);
console.log('app.sleepMonitor:', app?.sleepMonitor);
```

### 步骤4: 检查按钮元素
```javascript
const btn = document.getElementById('sleepStartBtn');
console.log('按钮存在:', !!btn);
console.log('按钮onclick:', btn?.onclick);
console.log('按钮可见:', btn?.style.display !== 'none');
```

### 步骤5: 手动调用函数
```javascript
// 尝试手动调用
try {
    startSleepMonitor();
    console.log('✅ 函数调用成功');
} catch (e) {
    console.error('❌ 函数调用失败:', e);
}
```

## 📊 诊断结果解读

### 正常情况应该看到：
```
✅ Chart.js: 已加载
✅ FFT: 已加载
✅ BLE: 已加载
✅ RadarDataProcessor: 已加载
✅ SleepMonitor: 已加载
✅ app: 已加载
✅ startSleepMonitor(): 已定义
✅ stopSleepMonitor(): 已定义
✅ resetSleepData(): 已定义
```

### 异常情况：

#### 情况A: SleepMonitor未加载
```
❌ SleepMonitor: 未找到
```
**原因**: sleep-monitor.js未正确加载或未导出类
**解决**: 检查文件路径和导出代码

#### 情况B: 函数未定义
```
❌ startSleepMonitor(): 未找到
```
**原因**: app.js未正确加载或函数定义有误
**解决**: 检查app.js是否有语法错误

#### 情况C: app对象为undefined
```
❌ app: 未找到
```
**原因**: RadarWebApp类初始化失败
**解决**: 检查app.js的构造函数是否有错误

## 🚀 快速修复方法

如果确认是SleepMonitor类未导出的问题，可以在浏览器控制台临时修复：

```javascript
// 临时解决方案（需要重新定义类，这里只是示例）
console.log('尝试临时修复...');

// 检查sleep-monitor.js是否已加载但未导出
if (typeof SleepMonitor === 'undefined') {
    // 重新加载脚本
    const script = document.createElement('script');
    script.src = 'sleep-monitor.js?v=' + Date.now();
    script.onload = function() {
        console.log('✅ sleep-monitor.js重新加载完成');
        console.log('SleepMonitor:', typeof SleepMonitor);
    };
    document.head.appendChild(script);
}
```

## 📝 提供诊断信息

如果以上步骤都无法解决，请在控制台运行以下命令并提供输出：

```javascript
// 收集诊断信息
console.log('=== 诊断信息 ===');
console.log('1. SleepMonitor类:', typeof SleepMonitor);
console.log('2. startSleepMonitor函数:', typeof startSleepMonitor);
console.log('3. app对象:', typeof app);
console.log('4. app.processor:', app?.processor);
console.log('5. 按钮存在:', !!document.getElementById('sleepStartBtn'));
console.log('6. Chart.js:', typeof Chart);
console.log('7. 页面URL:', window.location.href);
console.log('8. 错误列表:', window.__errors || '无');
console.log('=================');
```

## ✅ 成功标志

当一切正常时，点击按钮后应该看到：

**控制台输出**:
```
😴 开始睡眠监测...
📊 蓝牙连接状态: false
📊 活动监测状态: false
📊 创建SleepMonitor实例...
🎨 初始化睡眠监测图表...
✅ 睡眠阶段时间线图初始化成功
✅ RMS趋势图初始化成功
✅ 睡眠周期饼图初始化成功
✅ 睡眠监测已启用，等待数据...
```

**页面变化**:
- "开始睡眠监测" 按钮隐藏
- "停止监测" 按钮显示
- 睡眠事件日志显示 "✅ 睡眠监测已启动"

---

**需要帮助？** 运行诊断工具后，告诉我具体的错误信息，我可以提供更精确的解决方案。