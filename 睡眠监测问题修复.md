# 睡眠监测模块问题修复报告

## 🔍 问题描述
点击"开始睡眠监测"按钮没有任何反应。

## 🐛 根本原因
**SleepMonitor类未导出到全局作用域**

`sleep-monitor.js` 文件中定义了 `SleepMonitor` 类，但文件末尾没有导出代码，导致 `app.js` 中无法访问该类。

## ✅ 修复方案

### 修改文件：`web/sleep-monitor.js`
在文件末尾添加导出代码：

```javascript
// 导出SleepMonitor类到全局作用域
if (typeof window !== 'undefined') {
    window.SleepMonitor = SleepMonitor;
    console.log('✅ SleepMonitor类已导出到全局作用域');
}
```

## 📋 睡眠监测功能说明

### 核心功能
1. **零交叉率(MCR)计算** - 检测体动频率
2. **RMS能量计算** - 检测运动强度  
3. **睡眠阶段分类** - 清醒/浅睡/深睡/REM
4. **睡眠事件检测** - 入睡/醒来/翻身
5. **睡眠质量报告生成**

### 使用流程
1. **连接蓝牙设备**（必须先连接）
2. **点击"开始睡眠监测"按钮**
3. **系统自动分析加速度计数据**
4. **实时显示睡眠阶段和指标**
5. **点击"停止监测"生成报告**

### 工作原理

#### 数据输入
- 使用蓝牙设备的IMU加速度计数据（ax, ay, az）
- 采样率：50Hz
- 窗口大小：6秒（300样本）
- 滑动步长：1秒（50样本）

#### 睡眠阶段判定阈值

| 参数 | 清醒 | 浅睡 | 深睡 | REM |
|------|------|------|------|-----|
| RMS (g) | > 0.05 | < 0.03 | < 0.02 | 0.02-0.05 |
| MCR (次/秒) | > 5 | - | < 2 | 3-8 |

#### 睡眠阶段分类逻辑
```javascript
// 判断流程：
1. RMS > 0.05g → 清醒
2. RMS < 0.02g && MCR < 2 → 深睡
3. RMS 0.02-0.05g && MCR 3-8 → REM
4. RMS < 0.03g → 浅睡
5. 其他 → 清醒
```

## 🎯 验证步骤

### 1. 打开浏览器开发者工具（F12）
### 2. 刷新页面，检查控制台输出
应该看到：
```
✅ SleepMonitor类已导出到全局作用域
```

### 3. 测试睡眠监测功能
```javascript
// 在控制台执行：
console.log('SleepMonitor:', typeof SleepMonitor);
// 应该输出: SleepMonitor: function

// 测试创建实例：
const testMonitor = new SleepMonitor(50, 10);
console.log('测试实例:', testMonitor);
```

### 4. 完整测试流程
1. 连接蓝牙设备
2. 点击"开始睡眠监测"
3. 检查控制台输出：
   ```
   😴 开始睡眠监测...
   📊 蓝牙连接状态: true
   📊 创建SleepMonitor实例...
   🎨 初始化睡眠监测图表...
   ✅ 睡眠监测已启用，等待数据...
   ```
4. 查看睡眠事件日志面板
5. 观察实时图表更新

## 📊 UI元素检查

### 必需的DOM元素
```html
<!-- 按钮 -->
<button id="sleepStartBtn" onclick="startSleepMonitor()">😴 开始睡眠监测</button>
<button id="sleepStopBtn" onclick="stopSleepMonitor()">⏹️ 停止监测</button>

<!-- 显示区域 -->
<div id="sleepEventLog"></div>
<div id="sleepCurrentStage"></div>
<div id="sleepTotalTime"></div>
<div id="sleepEfficiency"></div>

<!-- 图表画布 -->
<canvas id="sleepStageTimelineChart"></canvas>
<canvas id="sleepRMSChart"></canvas>
<canvas id="sleepCycleChart"></canvas>
```

## 🔧 常见问题排查

### Q1: 点击按钮后控制台报错 "SleepMonitor is not defined"
**原因**: sleep-monitor.js未正确加载或导出失败

**解决方案**:
1. 检查HTML中是否引入了sleep-monitor.js：
   ```html
   <script src="sleep-monitor.js?v=20260128-1"></script>
   ```
2. 确保脚本在app.js之前加载
3. 强制刷新浏览器（Ctrl+F5）清除缓存

### Q2: 按钮点击后没有任何反应
**原因**: JavaScript错误或app对象未初始化

**解决方案**:
1. 打开开发者工具查看Console错误
2. 检查app对象是否存在：
   ```javascript
   console.log('app:', window.app);
   ```
3. 检查是否有其他JavaScript错误阻止执行

### Q3: 显示"应用未初始化"
**原因**: app对象创建失败

**解决方案**:
1. 检查app.js是否正确加载
2. 检查是否有语法错误：
   ```bash
   node -c app.js
   ```
3. 查看控制台完整错误信息

### Q4: 蓝牙未连接时点击按钮
**说明**: 睡眠监测可以在没有蓝牙的情况下启动，但不会有数据输入

**处理**: 
- 功能会启动，但等待数据输入
- 建议先连接蓝牙设备再启动监测

### Q5: 图表不显示
**原因**: Chart.js未加载或canvas元素不存在

**解决方案**:
1. 确认Chart.js已加载：
   ```html
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   ```
2. 检查canvas元素是否存在
3. 查看控制台是否有图表初始化错误

## 📝 数据流程图

```
蓝牙设备 (IMU)
    ↓
BLE数据接收 (app.handleBLELine)
    ↓
提取加速度计数据 (accX, accY, accZ)
    ↓
检查睡眠监测启用状态 (sleepMonitorEnabled)
    ↓
添加数据到SleepMonitor (addAccelerometerData)
    ↓
滑动窗口处理 (6秒窗口, 1秒步长)
    ↓
计算指标 (RMS, MCR)
    ↓
分类睡眠阶段 (classifySleepStage)
    ↓
检测睡眠事件 (detectSleepEvents)
    ↓
更新统计数据 (updateStatistics)
    ↓
定时更新UI (每2秒)
    ↓
更新图表 (updateCharts)
```

## 🎨 图表说明

### 1. 睡眠阶段时间线图
- **类型**: 阶梯图
- **Y轴**: 0=清醒, 1=浅睡, 2=深睡, 3=REM
- **X轴**: 时间（HH:MM）
- **更新频率**: 实时

### 2. RMS能量趋势图
- **类型**: 折线图
- **Y轴**: RMS值（g）
- **X轴**: 时间（HH:MM）
- **特点**: 自动调整Y轴范围以放大微小变化

### 3. 睡眠周期饼图
- **类型**: 圆环图
- **数据**: 深睡/浅睡/REM/清醒时间占比
- **单位**: 分钟

## 🏥 睡眠质量评分标准

### 评分维度（满分100分）
1. **深睡比例（30分）** - 理想范围：20-25%
2. **睡眠效率（30分）** - 理想值：>85%
3. **翻身频率（20分）** - 理想值：<3次/小时
4. **REM睡眠比例（20分）** - 理想范围：20-25%

### 质量等级
- **优秀**: 80-100分
- **良好**: 60-79分
- **一般**: 40-59分
- **差**: 0-39分

## 🔬 技术细节

### MCR（零交叉率）计算
```javascript
// 算法：
1. 计算信号均值
2. 统计信号与均值交叉的次数
3. 转换为每秒交叉次数
MCR = crossings / duration
```

### RMS（均方根）计算
```javascript
// 算法：
RMS = sqrt((ax1^2 + ay1^2 + az1^2 + ... + axn^2 + ayn^2 + azn^2) / n)
```

## 📖 使用建议

### 最佳实践
1. **测试环境**: 安静环境，宠物处于休息状态
2. **设备放置**: 确保IMU传感器固定在宠物身上
3. **监测时长**: 建议至少监测1小时以获得准确数据
4. **数据采集**: 保持蓝牙连接稳定

### 数据解读
- **频繁清醒**: 可能环境噪音或不适
- **深睡不足**: 可能白天活动不足
- **REM不足**: 可能睡眠质量差或压力大
- **翻身频繁**: 可能睡眠环境不舒适

## 🚀 后续优化建议

1. **增强算法**: 
   - 加入机器学习模型
   - 个性化阈值调整
   
2. **功能扩展**:
   - 睡眠姿势识别
   - 打鼾检测（需要音频传感器）
   - 睡眠周期预测

3. **用户体验**:
   - 添加睡眠历史对比
   - 导出PDF报告
   - 睡眠质量趋势分析

## ✅ 修复完成检查清单

- [x] SleepMonitor类导出到全局作用域
- [ ] 浏览器控制台无错误
- [ ] 点击按钮后按钮状态切换
- [ ] 控制台输出启动日志
- [ ] 睡眠事件日志面板显示消息
- [ ] 图表正常初始化
- [ ] 接收到加速度计数据后图表更新
- [ ] 睡眠阶段正确分类
- [ ] 统计数据正常累积

---

**修复时间**: 2026-01-28  
**状态**: ✅ 已修复核心问题，等待测试验证