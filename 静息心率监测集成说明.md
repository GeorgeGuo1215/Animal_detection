# 静息心率监测与活动监测集成说明

## 📋 功能概述

将静息心率监测模块与活动监测模块深度集成，使用活动监测的强度判断来确定宠物是否处于静息状态，并添加实时图表显示。

## 🔧 核心改进

### 1. 智能静息判定

**原方案**：使用IMU陀螺仪数据的标准差判断是否静息
- 计算gx/gy/gz的标准差
- 判断总体运动幅度是否小于阈值

**新方案**：优先使用活动监测模块的强度分类
- 直接使用 `activityMonitor.currentIntensity`
- 当强度为 `'resting'` 时判定为静息状态
- 降级方案：如果活动监测未启用，仍使用IMU判断

**优势**：
- 更准确：活动监测使用ENMO等多维度指标
- 更可靠：基于成熟的活动强度分类算法
- 更一致：与活动监测模块保持一致的判定标准

### 2. 实时数据追踪

新增实时数据结构：
```javascript
// 当前静息数据
this.currentRestingHR = null;      // 当前静息心率
this.currentRestingRR = null;      // 当前静息呼吸率
this.lastRestingUpdateTime = null; // 最后更新时间

// 每分钟数据
this.minuteData = [];              // {timestamp, avgHR, avgRR, count}
this.currentMinuteHR = [];         // 当前分钟内的心率数据
this.currentMinuteRR = [];         // 当前分钟内的呼吸率数据

// 每小时数据
this.hourlyData = Array(24).fill(null).map(() => ({
    avgHR: 0,
    avgRR: 0,
    count: 0,
    samples: []
}));
```

### 3. 三层图表可视化

#### 实时静息心率图
- **类型**：折线图
- **数据**：最近60条静息心率记录
- **更新频率**：实时（每次记录新数据时）
- **用途**：观察心率的即时变化趋势

#### 每分钟静息心率图
- **类型**：柱状图
- **数据**：每分钟的平均静息心率
- **保留时长**：最近60分钟
- **用途**：观察短期心率变化模式

#### 每小时静息心率图
- **类型**：柱状图
- **数据**：24小时的平均静息心率
- **更新方式**：累积计算
- **用途**：观察全天心率分布规律

## 📊 数据流程

```
蓝牙数据 → 活动监测模块
              ↓
         判定活动强度
              ↓
    currentIntensity = 'resting'?
              ↓ 是
         静息监测模块
              ↓
    记录心率和呼吸率
              ↓
    ├─ 实时数据更新
    ├─ 每分钟数据聚合
    ├─ 每小时数据聚合
    └─ 图表实时更新
```

## 🎯 使用流程

### 1. 启动活动监测（必需）
```
连接蓝牙 → 开始活动监测
```
活动监测会实时判定宠物的活动强度。

### 2. 启动静息监测
```
开始静息监测
```
系统会自动：
- 检测活动监测是否启用
- 使用活动强度判定静息状态
- 初始化三个图表

### 3. 观察实时数据
在"实时静息数据"面板中查看：
- 当前心率（仅在静息时更新）
- 当前呼吸率（仅在静息时更新）
- 最后更新时间

### 4. 分析图表
- **实时图**：观察心率波动
- **分钟图**：查看短期趋势
- **小时图**：分析全天规律

## 🔍 关键代码修改

### update() 方法
```javascript
// 检查是否有活动监测模块
const hasActivityMonitor = this.app.activityMonitor && this.app.activityMonitorEnabled;

// 判断是否处于静息状态
let isCurrentlyResting = false;

if (hasActivityMonitor) {
    // 使用活动监测的强度判断（优先）
    isCurrentlyResting = this.app.activityMonitor.currentIntensity === 'resting';
} else {
    // 降级到IMU稳定性判断
    isCurrentlyResting = this.checkIMUStable();
}
```

### 数据记录
```javascript
if (this.app.currentHeartRate && this.app.currentRespiratoryRate) {
    // 更新当前静息数据
    this.currentRestingHR = this.app.currentHeartRate;
    this.currentRestingRR = this.app.currentRespiratoryRate;
    this.lastRestingUpdateTime = now;

    // 添加到当前分钟数据
    this.currentMinuteHR.push(this.currentRestingHR);
    this.currentMinuteRR.push(this.currentRestingRR);

    // 更新分钟和小时数据
    this.updateMinuteData(now);
    this.updateHourlyData(now);
}
```

## 📈 预期效果

### 正常静息模式
```
时间      活动强度    心率    呼吸率   记录状态
22:00     resting    72bpm   18bpm    ✅ 记录
22:01     resting    71bpm   17bpm    ✅ 记录
22:02     light      85bpm   22bpm    ❌ 不记录（活动中）
22:03     resting    73bpm   18bpm    ✅ 记录
```

### 图表显示
- **实时图**：显示72→71→73的变化曲线
- **分钟图**：22:00显示71.5bpm，22:03显示73bpm
- **小时图**：22:00-23:00累积平均值

## 🎨 UI 更新

### 实时数据面板
- 紫色渐变背景，醒目显示
- 3列布局：当前心率、当前呼吸、最后更新
- 大字体显示数值，便于快速查看

### 图表布局
- 每个图表占据2列宽度
- 统一高度250px
- 响应式设计，移动端自适应

## ⚠️ 注意事项

1. **必须先启动活动监测**
   - 静息判定依赖活动监测的强度分类
   - 如果活动监测未启用，会降级到IMU判断

2. **数据记录条件**
   - 必须处于静息状态（resting）
   - 必须有有效的心率和呼吸率数据
   - 必须持续稳定5秒以上

3. **图表更新频率**
   - 实时图：每次记录新数据时更新
   - 分钟图：每分钟聚合一次
   - 小时图：实时累积更新

4. **数据保留策略**
   - 实时图：最近60条记录
   - 分钟图：最近60分钟
   - 小时图：24小时循环

## 🚀 未来优化方向

1. **心率变异性分析**
   - 计算HRV指标
   - 评估自主神经功能

2. **睡眠质量评估**
   - 结合睡眠监测模块
   - 分析睡眠期间的心率变化

3. **异常检测**
   - 检测心率异常波动
   - 预警心率过高/过低

4. **长期趋势分析**
   - 周/月静息心率趋势
   - 健康状况评估

5. **数据导出**
   - 导出CSV格式
   - 生成PDF报告

## 🧪 测试步骤

### 1. 刷新页面
```
Cmd+Shift+R (Mac) 或 Ctrl+Shift+R (Windows)
```

### 2. 连接蓝牙并启动活动监测
```
连接蓝牙 → 开始活动监测
```

### 3. 启动静息监测
```
开始静息监测
```

### 4. 观察控制台
应该看到：
```
🎯 开始静息监测 - 系统将自动识别静息状态
✅ 使用活动监测模块判定静息状态
🎨 初始化静息心率图表...
✅ 实时静息心率图初始化成功
✅ 每分钟静息心率图初始化成功
✅ 每小时静息心率图初始化成功
```

### 5. 等待静息状态
当活动强度变为"静息"时，应该看到：
```
🛌 进入静息状态 (活动监测判定，已稳定5.0秒)
```

### 6. 验证数据更新
- 实时数据面板显示当前心率和呼吸率
- 实时图表开始绘制曲线
- 每分钟图表在新的一分钟时更新
- 每小时图表实时累积

## 📝 相关文件

- `web/resting-monitor.js` - 静息监测模块（已修改）
- `web/activity-monitor.js` - 活动监测模块（提供强度判定）
- `web/index.html` - UI界面（已添加图表）
- `web/app.js` - 主应用（集成两个模块）

---

**版本**: 2.0.0
**更新时间**: 2026-01-28
**新功能**:
- 集成活动监测强度判定
- 添加实时/分钟/小时三层图表
- 优化数据追踪和可视化
